<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>emacs</title>
<meta name="generator" content="Org Mode" />
<link rel="stylesheet" type="text/css" href="org-default.css" />
</head>
<body>
<div id="content" class="container">
<nav aria-label="breadcrumb" style="--pico-nav-breadcrumb-divider: '|';" id="org4bbab9c">
<ul class="org-ul">
<li><a href="index.html#ID-3a34d6d7-6f37-4573-b20e-3c93894e54ac">üè†</a></li>
<li><a href="site_map.html#ID-30ea5e38-9b41-4bcd-8631-76821e93e294">üó∫</a></li>
</ul>
</nav>
<div id="outline-container-orgdfba8e8" class="outline-2">
<h2 id="orgdfba8e8">Emacs</h2>
<div class="outline-text-2" id="text-orgdfba8e8">
</div>
<div id="outline-container-org096ee27" class="outline-3">
<h3 id="org096ee27">emacs notes</h3>
<div class="outline-text-3" id="text-org096ee27">
<ul class="org-ul">
<li><code>toggle-debug-on-quit</code> for stacktraces of hung commands</li>
<li>pgtk enabled <code>broadwayd</code> port 8080 with apps env var <code>GDK_BACKEND=broadway</code> (deprecated in GTK 5)</li>
<li>magit-generate-changelog for commit msg</li>
<li>gnus needs app password from google for 2fa or oauth token from gcloud</li>
<li>webkit environment variable(s) for built-in browser
<ul class="org-ul">
<li><code>WEBKIT_FORCE_SANDBOX="0"</code> is obe use <code>WEBKIT_DISABLE_SANDBOX_THIS_IS_DANGEROUS=1</code>
<ul class="org-ul">
<li>maybe set <code>GST_PLUGIN_PATH</code></li>
</ul></li>
</ul></li>
<li>android port manual entry specifies enabling 'special app permissions' for all files to access <code>/sdcard</code>
<ul class="org-ul">
<li>android port of fdroid is old and branch is unmerged; newer builds are on <a href="https://sourceforge.net/projects/android-ports-for-gnu-emacs/">sourceforge</a>
<ul class="org-ul">
<li>custom build of termux for supporting utils</li>
</ul></li>
</ul></li>
<li>signal-cli integration init <code>signal-cli link --name device_name | head -1 | qrencode --type=UTF8</code></li>
<li>guile scheme port of emacs lisp <a href="https://codeberg.org/ramin_hal9001/gypsum/">https://codeberg.org/ramin_hal9001/gypsum/</a></li>
<li>guile-emacs project <a href="https://git.hcoop.net/bpt/emacs.git">https://git.hcoop.net/bpt/emacs.git</a></li>
<li>literal org blocks for artist mode by using <code>#+BEGIN_EXAMPLE</code> and <code>#+END_EXAMPLE</code> with each line starting with a colon then a space (avoid special chars)</li>
</ul>
<div class="org-src-container">
<pre class="src src-emacs-lisp" id="orgbafcee7">(use-package signal-msg ; https://github.com/AsamK/signal-cli
  :commands (signal-msg-new-message) ; jam/signal-msg-rec
  :config (setq signal-msg-username (alist-get 'secret (auth-source-pass-parse-entry "signal/account"))
                signal-msg-number (alist-get 'secret (auth-source-pass-parse-entry "signal/phone")))
  (advice-add 'signal-msg-send :override #'jam/signal-msg-send))

;;;###autoload
(defun jam/signal-msg-send ()
  "Override to use -a account notation and stdin for sending buffer to signal-cli"
  (interactive)
  (let ((exit-code (call-process-region
                    (point-min)
                    (point-max)
                    "signal-cli"
                    nil                                  ; delete
                    nil                                  ; buffer
                    nil                                  ; display
                    "-a" signal-msg-number "send" "--message-from-stdin" signal-msg-dest-number)))
    (if (= exit-code 0)
        (kill-buffer)
      (warn (format "Something went wrong. signal-cli returned %d" exit-code)))))

;;;###autoload
(defun jam/signal-msg-rec ()
  "Reads all json encoded messages from signal-cli into *Signal* buffer"
  (interactive)
  (with-temp-buffer (progn (call-process "signal-cli" nil (current-buffer) nil "--output=json" "receive"); (call-process "cat" nil (current-buffer) nil "signals.json")
                           ;(message "current buffer is %s " (buffer-string))
                           (goto-char (point-min))
                           (unwind-protect
                               (while (not (eobp))
                                 (let* (;(message-json (json-read-file "signals.json"))
                                        (message-json (json-read))
                                        (message-content (alist-get 'envelope message-json ))
                                        (message-from (alist-get 'sourceName message-content))
                                        (message-data (alist-get 'dataMessage message-content))
                                        (message-text (alist-get 'message message-data)))
                                   ;(message "\nFrom: %s\nMessage: %s\n" message-from message-text)
                                   (with-current-buffer (get-buffer-create "*Signal*") (insert (format "\nFrom: %s\nMessage: %s\n" message-from message-text)))))))))
</pre>
</div>
<div class="org-src-container">
<pre class="src src-emacs-lisp" id="org69b2545">;;;###autoload
(defun jam/guix-env()
  "Guix variables for local guix daemon/client"
  (interactive)
  (require 'xdg)
  (setenv "GUIX_DAEMON_SOCKET" (concat (file-name-as-directory (xdg-data-home)) (file-name-as-directory "guix") (file-name-as-directory "var") (file-name-as-directory "guix") (file-name-as-directory "daemon-socket") "socket"))
  (setenv "GUIX_DATABASE_DIRECTORY" (concat (file-name-as-directory (xdg-data-home)) (file-name-as-directory "guix") (file-name-as-directory "var") (file-name-as-directory "guix") "db"))
  (setenv "GUIX_LOG_DIRECTORY" (concat (file-name-as-directory (xdg-data-home)) (file-name-as-directory "guix") (file-name-as-directory "var") (file-name-as-directory "log") "guix"))
  (setenv "GUIX_STATE_DIRECTORY" (concat (file-name-as-directory (xdg-data-home)) (file-name-as-directory "guix") (file-name-as-directory "var") "guix"))
  (setenv "GUIX_CONFIGURATION_DIRECTORY" (concat (file-name-as-directory (xdg-config-home))(file-name-as-directory "guix") "etc"))
  (setenv "GUIX_LOCPATH" (concat (file-name-as-directory (xdg-data-home)) (file-name-as-directory "guix") (file-name-as-directory "var") (file-name-as-directory "guix") (file-name-as-directory "profiles") (file-name-as-directory "per-user") (file-name-as-directory "root") (file-name-as-directory "guix-profile") (file-name-as-directory "lib") "locale"))
  (setenv "NIX_STORE" (concat (file-name-as-directory (xdg-data-home)) (file-name-as-directory "guix") (file-name-as-directory "gnu") "store")) ; NIX_STORE_DIR
  (setenv "PATH" (concat (getenv "PATH") path-separator (concat (file-name-as-directory (xdg-data-home)) (file-name-as-directory "guix") "bin"))))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp" id="org03d22b5">; rss/atom feed reader
(use-package newsticker
  :ensure nil ; built-in
  :commands (newsticker-start newsticker-treeview newsticker-plainview newsticker-stop)
  :bind (:map jam/open ("n" . newsticker-treeview)
         :map jam/toggle ("n" . newsticker-stop)
         :map newsticker-treeview-item-mode-map ("d" . (lambda () (interactive); Download the current newsticker enclosure to tmpdir/newsticker/feed/title
                                                         (let* ((item (newsticker--treeview-get-selected-item))
                                                                (feedname "newsticker")
                                                                (title (newsticker--title item))
                                                                (enclosure (newsticker--enclosure item))
                                                                (download-dir (file-name-as-directory
                                                                               (expand-file-name (newsticker--title (newsticker--treeview-get-selected-item))
                                                                                                 (expand-file-name feedname (expand-file-name "newsticker" temporary-file-directory))))))
                                                           (newsticker-download-enclosures feedname item)
                                                           (message download-dir)))))
  :init
  (setq newsticker-frontend 'newsticker-treeview
        newsticker-dir (concat user-emacs-directory (file-name-as-directory ".local") (file-name-as-directory "cache") "newsticker")
        newsticker-automatically-mark-items-as-old nil
        newsticker-automatically-mark-visited-items-as-old t
        newsticker-url-list-defaults nil
        newsticker-url-list '(("styx" "https://odysee.com/$/rss/@Styxhexenhammer666:2"))))

;debbugs: track emacs bugs (guix moved to forejo). alternative is bookmarking websites/mailing lists
(use-package debbugs
  ;:pin gnu
  :bind (:map jam/search ("b" . debbugs-gnu-bugs)); bug number search
  :commands (debbugs-gnu debbugs-gnu-tagged debbugs-org debbugs-org-tagged debbugs-org-mode debbugs-gnu-bugs debbugs-gnu-guix-search debbugs-org-guix-search)
  :config ;(setq org-link-elisp-confirm-function nil)
  (setq debbugs-gnu-default-packages '("guix-patches"))
  (require 'debbugs-guix) (require 'debbugs-org) (require 'debbugs-gnu) (require 'debbugs-browse)); C-u M-x debbugs-gnu guix-patches n y then tag with t

;combobulate?: structural editing. alternative is regex
(use-package combobulate
  :init (setq combobulate-key-prefix "C-c e")
  :hook (((python-ts-mode yaml-ts-mode) . combobulate-mode))
  :vc (:url "https://github.com/mickeynp/combobulate" :rev :newest) ; install from source with package.el or url-copy-file
  :load-path ("/gnu/git/combobulate"))

;eglot-x?: rust-analyzer extensions for memory layout and structural-search-replace. alternative is to copy the functions
(use-package eglot-x
  :after eglot
  :config (eglot-x-setup)
  :vc (:url "https://github.com/nemethf/eglot-x" :rev :newest))

;atomic-chrome?: counterpart to https://github.com/KarimAziev/chrome-emacs for using emacs to edit browser buffers. alternative is copy-paste
(use-package atomic-chrome
  :vc (:url "https://github.com/KarimAziev/atomic-chrome" :rev "3387284d8789cf1d2a54425019a27f2e099b80d5")
  :bind (:map jam/toggle ("b" . atomic-chrome-toggle-server))
  :commands (atomic-chrome-start-server atomic-chrome-toggle-server)
  :config
  (setq-default atomic-chrome-buffer-open-style 'frame)
  (setq-default atomic-chrome-auto-remove-file t)
  (setq-default atomic-chrome-url-major-mode-alist
                '(("github.com" . gfm-mode)
                  ("gitlab.com" . gfm-mode)))
  (add-to-list 'atomic-chrome-create-file-strategy `(,(concat user-emacs-directory (file-name-as-directory ".local") (file-name-as-directory "cache") "src") :extension ("js" "ts" "tsx" "jsx" "cjs" "mjs"))))
</pre>
</div>

<ul class="org-ul">
<li>German air control ATC ran on emacs in the 90's</li>
<li>calc can plot with gnuplot
<ul class="org-ul">
<li><code>set yrange [0:50]</code>, <code>set xrange [0:2200]</code>, <code>plot 4 * sqrt(x + 10) / log10(x + 10) - 4 * sqrt(10)</code></li>
</ul></li>
</ul>
</div>
<div id="outline-container-org3e4fe22" class="outline-4">
<h4 id="org3e4fe22">org-mode notes</h4>
<div class="outline-text-4" id="text-org3e4fe22">
<ul class="org-ul">
<li>noweb can link code verbatium with <a id="orgb1755ec"></a> or evaluate it with <a id="orgb015a6f"></a>()</li>
<li><code>#+INCLUDE "file.org::selector" :only-contents t</code> to select heading contents to include from other files</li>
<li>disable tangling with <code>:tangle no</code> on src blocks</li>
</ul>
<div class="org-src-container">
<pre class="src src-emacs-lisp" id="org57f443f">(ignore-errors
  (let* ((base-dir (file-name-directory (or load-file-name buffer-file-name)))
         (readme (concat base-dir (file-name-as-directory "..") (file-name-as-directory "..") "README.org"))
         (readme-time (file-attribute-modification-time (file-attributes readme)))
         (emacs-org (concat base-dir "emacs.org"))
         (emacs-org-time (file-attribute-modification-time (file-attributes emacs-org))))
    (if (time-less-p emacs-org-time readme-time); set timestamp of emacs.html when readme.org has newer edits
      (set-file-times (concat base-dir "emacs.html") (time-add readme-time (seconds-to-time 1))))))
</pre>
</div>
</div>
</div>
<div id="outline-container-orgdc5cd5b" class="outline-4">
<h4 id="orgdc5cd5b">emacs config notes</h4>
<div class="outline-text-4" id="text-orgdc5cd5b">
<ul class="org-ul">
<li>installs to <code>${XDG_CONFIG_HOME}/emacs</code></li>
<li>early-init will use guix-home packages if emacs package directory exists inside it otherwise uses use-package to download</li>
<li>Pure elisp instead of makefiles and shell scripts
<ul class="org-ul">
<li>sesquicolon 'shebang'</li>
<li>build system
<ul class="org-ul">
<li>runs any untangled elisp scripts</li>
<li>sets timestamps</li>
<li>exports custom elements for html/org-roam and expands INCLUDE directives</li>
<li>build site
<ul class="org-ul">
<li>git worktree</li>
<li>sitemap self untangles an org document
<ul class="org-ul">
<li>site search uses sqlite fts index and stores the db in opfs for reuse</li>
</ul></li>
<li>copy js, css, png, sqlite db, etc by timestamp
<ul class="org-ul">
<li>migrated css from custom hand rolled to bulma then to pico for better defaults and less configuration</li>
</ul></li>
<li>navbar contains index/sitemap links
<ul class="org-ul">
<li>INCLUDE in each page for css/navbar</li>
</ul></li>
</ul></li>
<li>wraps couple common commands</li>
</ul></li>
</ul></li>
<li>org roam dialies are a date tree journal</li>
<li>tangled files set own timestamps in scripts</li>
<li>defaults copied from doom/spacemacs when dropped</li>
<li>all keys bounds under C-c c</li>
<li>prefer defaults when possible</li>
<li>prefer eshell for tramp traversal</li>
<li>gnus over newsticker as more backends and own the frame</li>
<li>prefix named interactive commands over inline functions for M-x and binds</li>
<li>added mouse clicking to command buffer
<ul class="org-ul">
<li>special case handling of Files:</li>
</ul></li>
<li>android support with termux build</li>
<li>save files locally under .local/cache and .local/etc</li>
<li>do not hardcode paths and use xdg</li>
<li>tricks to speed up init
<ul class="org-ul">
<li>defer package loading with use-package</li>
<li>skip packages at startup</li>
<li>add memory for skipping gc</li>
<li>unbinding file-handler matching</li>
<li>native code</li>
<li>package-quickstart</li>
<li>autoload functions</li>
<li>dump saves a little time</li>
<li>after-init hooks</li>
<li>setq inhibits-*</li>
<li>disable frame features without loading</li>
</ul></li>
<li>gc with idle timer</li>
<li>cua for copy/paste</li>
<li>xterm/broadwayd/daemon support</li>
<li>transparent background</li>
<li>extra mouse support</li>
<li>sound alert</li>
<li>packages in README for extras
<ul class="org-ul">
<li>functions under <code>M-x jam/</code> prefix
<ul class="org-ul">
<li>sudo-edit</li>
<li>auth-display
<ul class="org-ul">
<li>vendored totp implementation for authinfo password storage</li>
</ul></li>
<li>draw</li>
<li>eshell</li>
<li>save-all (buffers)</li>
<li>mpv-play</li>
<li>screenshot
<ul class="org-ul">
<li>image-crop is a bind</li>
<li>ffmpeg for resize <code>ffmpeg -i cropped.png -vf "scale=1280:720" scaled.png</code></li>
</ul></li>
<li>replace unicode
<ul class="org-ul">
<li>ZERO WIDTH NO-BREAK SPACE(BOM), ZERO WIDTH SPACE, RIGHT-TO-LEFT MARK, RIGHT-TO-LEFT OVERRIDE, LEFT-TO-RIGHT MARK, OBJECT REPLACEMENT CHARACTER</li>
</ul></li>
<li>compile-init-bytecode</li>
</ul></li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org6200083" class="outline-3">
<h3 id="org6200083">emacs-config README</h3>
<div class="outline-text-3" id="text-org6200083">
<p>
This configuration is for emacs &gt;= 30
</p>

<p>
Third party packages:
</p>

<p>
guix: package/environment management. alternative is cli and setting exec-path-from-shell/environment
</p>

<p>
eat: graphical terminal emulation. alternative is built-in multi-term w/o visual commands
</p>

<p>
magit/forge/code-review: git/forge manipulation. alternative is built-in vc that lacks complex workflows like interactive rebase, forge pull requests or code review comments
</p>

<p>
org-roam: tag system for note database. alternative is org-node or self devised naming/search scheme with a datetree journal
</p>

<p>
undo-tree: undo edit persist restarts. alternative is built-in undo with session persistence redone
</p>

<p>
minions-mode: keeps the modeline visually brief with retained information. alternative is diminish/delight packages and config for each mode
</p>

<p>
osm: Map tile viewer. alternative is web browser viewing
</p>

<p>
gptel/llm-tool-collection: interface with llms. alternative is llm package or cli
</p>

<p>
dape/geiser-guile/pyvenv/(rust,yaml,python)-tree-sitter: language specific modes with more than regex.
</p>
</div>
<div id="outline-container-orgda6025e" class="outline-4">
<h4 id="orgda6025e">Clone</h4>
<div class="outline-text-4" id="text-orgda6025e">
<p>
Branch names diverging and "." complicate fetching the correct heads.
</p>

<div class="org-src-container">
<pre class="src src-sh" id="orgd3d596b">git clone --single-branch --recurse-submodules --shallow-submodules --depth=1 git@github.com:jamartin9/emacs-config.git
# get branch heads
git submodule foreach 'git checkout master'
</pre>
</div>
</div>
</div>
<div id="outline-container-orgfd39635" class="outline-4">
<h4 id="orgfd39635">Tangle Install</h4>
<div class="outline-text-4" id="text-orgfd39635">
<p>
Emacs untangles the script from the org file (using noweb to copy/eval code) while expanding INCLUDE directives.
Tangling is rerun when the org file is newer than the script (if present) and the html file.
Cleanup is done via the <code>clean</code> arguments to the <code>make-el</code> wrapper.
The wrapper is needed for org-roam, org-ids and html export tags.
</p>

<div class="org-src-container">
<pre class="src src-sh" id="orgb5b1c56">pwsh make-el.ps1 install
</pre>
</div>
</div>
</div>
<div id="outline-container-org0dd60e6" class="outline-4">
<h4 id="org0dd60e6">Link</h4>
<div class="outline-text-4" id="text-org0dd60e6">
<p>
Installable org files tangle to a script of the same name for installation.
The script needs itself and emacs on the PATH or CWD.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp" id="orgaf21d7a">(ignore-errors
      (make-symbolic-link (file-name-directory (or load-file-name buffer-file-name)) (concat (file-name-as-directory (if (getenv "XDG_CONFIG_HOME") (getenv "XDG_CONFIG_HOME") (concat (file-name-as-directory (getenv "HOME")) ".config"))) "emacs")))
</pre>
</div>
</div>
</div>
<div id="outline-container-orge76ac09" class="outline-4">
<h4 id="orge76ac09">Run</h4>
<div class="outline-text-4" id="text-orge76ac09">
<p>
The one line org-mode sesquicolon 'shebang' is a multipart shell/powershell wrapper.
Passed arguments to the elisp script are available by argv (ignoring ‚Äú‚Äì‚Äù and ‚Äú$@‚Äù).
To run with powershell use the same wrapper format with a .ps1 extension.
</p>
<div class="org-src-container">
<pre class="src src-sh" id="orgdc0a2b7">":"; emacs -Q --script README.sh -- $@ $args ; exit $? # -*- mode: emacs-lisp; lexical-binding: t; -*-
</pre>
</div>
</div>
</div>
<div id="outline-container-org9e3382d" class="outline-4">
<h4 id="org9e3382d">Cherry Picking</h4>
<div class="outline-text-4" id="text-org9e3382d">
<p>
Copy files by url with emacs
</p>
<div class="org-src-container">
<pre class="src src-elisp" id="org869fc00">(url-copy-file "https://raw.githubusercontent.com/jamartin9/emacs-config/master/init.el" "init.el")
(url-copy-file "https://raw.githubusercontent.com/jamartin9/emacs-config/master/early-init.el" "early-init.el")
(call-process "git" nil t nil "clone" "https://github.com/jamartin9/emacs-config")
</pre>
</div>
</div>
</div>
<div id="outline-container-org5e83776" class="outline-4">
<h4 id="org5e83776">Site</h4>
<div class="outline-text-4" id="text-org5e83776">
<p>
Clone the site
</p>
<div class="org-src-container">
<pre class="src src-sh" id="org303899f">git worktree add --track -b gh-pages ./gh-pages origin/gh-pages
</pre>
</div>

<p>
Build the updated site
</p>
<div class="org-src-container">
<pre class="src src-sh" id="orgfb15e5a">pwsh make-el.ps1 site
</pre>
</div>
</div>
</div>
</div>
</div>
</div>
</body>
</html>
