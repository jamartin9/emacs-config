<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>guix</title>
<meta name="generator" content="Org Mode" />
<link rel="stylesheet" type="text/css" href="org-default.css" />
</head>
<body>
<div id="content" class="container">
<nav aria-label="breadcrumb" style="--pico-nav-breadcrumb-divider: '|';" id="org5f250fa">
<ul class="org-ul">
<li><a href="index.html#ID-3a34d6d7-6f37-4573-b20e-3c93894e54ac">üè†</a></li>
<li><a href="site_map.html#ID-30ea5e38-9b41-4bcd-8631-76821e93e294">üó∫</a></li>
</ul>
</nav>
<div id="outline-container-org1ed7180" class="outline-2">
<h2 id="org1ed7180">Guix</h2>
<div class="outline-text-2" id="text-org1ed7180">
</div>
<div id="outline-container-org23b7a75" class="outline-3">
<h3 id="org23b7a75">Link manifest</h3>
<div class="outline-text-3" id="text-org23b7a75">
<div class="org-src-container">
<pre class="src src-elisp" id="orga41b034">(ignore-errors
(let* ((manifest-dir (file-name-as-directory (concat (file-name-as-directory (xdg-config-home)) "guix-manifests")))
        (manifest-dir-file (concat manifest-dir "user.scm")))
    (if (not (file-exists-p manifest-dir))
        (make-directory manifest-dir))
    (if (not (or (file-exists-p manifest-dir-file) (file-symlink-p manifest-dir-file)))
        (make-symbolic-link (concat (file-name-directory (or load-file-name buffer-file-name)) "user.scm") manifest-dir-file 1))))
</pre>
</div>
</div>
</div>
<div id="outline-container-orgf76f11b" class="outline-3">
<h3 id="orgf76f11b">User manifest</h3>
<div class="outline-text-3" id="text-orgf76f11b">
<div class="org-src-container">
<pre class="src src-scheme" id="orgf2fb8b2">;; Manifest for development env
(specifications-&gt;manifest
 '(
   ;; basic
   ;;"shepherd" ;;"glibc-utf8-locales"

   ;;"ungoogled-chromium-nvda" "ublock-origin-chromium"
   ;;"firefox-nvda"; --with-graft=mesa=nvda
   ;;"torbrowser"

   ;;"deluge" ;;"transmission"
   ;;"nzbget"
   ;;"steam-nvidia" ;; steam
   ;;"zfs"
   "strace"
   "perf"
   "flamegraph"
   "bpftrace"
   "bcc"

   ;; C dev
   ;;"make" ;;"cmake"
   ;;"glibc" ;; "musl"
   ;;"gcc-toolchain" ;;"clang-toolchain"
   "gdb" ;;"lldb"
   ;;"rr"
   ;;"binutils"
   ;;"module-init-tools"
   ;;"msr-tools"

   ;; java
   ;;"openjdk"
   ;;"maven"
   ;;"leiningen"
   ;;"clojure"

   ;; python
   ;;"python"
   ;;"vapoursynth";; "ffms2"

   ;; shell
   ;;"shellcheck" ;;"bash"
   "htop"; Requires CAP_NET_ADMIN for PERCENT_*_DELAY
   ;;"bottom"
   ;;"xclip"
   ;;"wl-clipboard"
   ;;"bc"
   ;;"jq"
   ;;"coreutils" ;;"busybox"
   ;;"less"
   ;;"gzip"
   ;;"fdisk" ;;"gparted"
   ;;"wget"
   ;;"diffutils"
   ;;"findutils"
   ;;"tar"
   ;;"gawk"
   ;;"which"
   ;;"sed"
   ;;"grep"
   ;;"patch"
   ;;"gash"
   ;;"gash-utils"
   ;;"alacritty"
   ;;"xterm"
   "screen"
   "ripgrep"
   "fd"

   ;; apps
   ;;"wine64"; "wine"
   ;;"winetricks"
   ;;"clamav"
   ;;"filezilla"
   ;;"lynx"
   ;;"libvirt"
   ;;"virt-manager"
   ;;"postgresql"
   ;;"sqlite"
   ;;"tigervnc-client"
   ;;"tigervnc-server" ; newer gdm supports rdp login
   ;;"searx"
   ;;"gnuradio"
   ;;"obs"
   ;;"virt-viewer" "qemu"; remote-viewer for spice
   ;;"dino" ; xmpp client
   ;;"flatpak" ;"xdg-utils" "xdg-dbus-proxy"; "xdg-desktop-portal-gtk" ;"shared-mime-info"; "xorg-server-wayland" ;(list glib "bin")
   ;;"waypipe"

   ;; docs
   ;;"libreoffice"
   ;;"calibre"
   ;;"biber"
   ;;"texlive"
   ;;"kiwix-desktop"

   ;; media
   ;;"blender"
   ;;"gimp"
   ;;"inkscape"
   ;;"vlc"
   ;;"mkvtoolnix"
   ;;"mediainfo"
   ;;"ffmpeg"
   ;;"gnuplot"
   ;;"makemkv"
   ;;"yt-dlp"
   ;;"mpv"; MAYBE add guix package for mpv with libvdpau-nvidia from nvidia-libs nonguix

   ;; net
   ;;"curl"
   ;;"whois"
   ;;"bind:utils"
   ;;"nmap"
   ;;"python-stem"
   ;;"onionshare"
   ;;"iptables"
   ;;"ebtables"
   ;;"wireshark"
   ;;"netcat"
   ;;"net-tools"
   ;;"openssh" ;;"dropbear"
   ;;"wireguard-tools"
   ;;"socat"
   ;;"tor"
   ;;"torsocks"
   ;;"i2pd"
   ;;"dnsmasq"

   ;; Desktop
   ;;"notification-daemon"
   ;;"nvidia-driver"
   ))
</pre>
</div>
</div>
</div>
<div id="outline-container-orgd086192" class="outline-3">
<h3 id="orgd086192">guix notes</h3>
<div class="outline-text-3" id="text-orgd086192">
<ul class="org-ul">
<li><a href="https://git.genenetwork.org/guix-north-america/about/">https://git.genenetwork.org/guix-north-america/about/</a> for NA substitute server ?</li>
<li>cuirass ci saves gc roots in <code>/var/guix/gcroots/profiles/per-user/cuirass/cuirass</code> for default of 30 days
<ul class="org-ul">
<li>can unlink and gc for space</li>
</ul></li>
<li><code>guix system image -t iso9660 ./installer.scm</code></li>
<li><code>GUIX_SANDBOX_EXTRA_MOUNTS=/path/to/extra/thing</code> for guix steam</li>
<li>transform options for source, c-toolchain, debug, grafts/inputs
<ul class="org-ul">
<li><code>--with-commit=SomeSuchPackage=XXX</code></li>
</ul></li>
<li><code>-L ./guix-channel</code> to use local channel changes</li>
<li><code>guix pack -S /bin=bin -S /sbin=sbin --localstatedir -RR guix bash-static</code></li>
<li><code>guix package --roll-back</code> to drop to last version</li>
<li>commit signing and downgrading flags are <code>--disable-authentication --allow-downgrades</code></li>
<li>platform specific binaries can be produces with the <code>--tune</code> flag</li>
<li>hpc channel for extra pytorch packages
<ul class="org-ul">
<li><a href="https://gitlab.inria.fr/guix-hpc/guix-hpc/">https://gitlab.inria.fr/guix-hpc/guix-hpc/</a></li>
<li>misc channels <a href="https://git.sr.ht/~whereiseveryone/toys/log">https://git.sr.ht/~whereiseveryone/toys/log</a> for services/packages (sops(secrets), cuda, android, rustup, lutris, ollama, tailscaled, jellyfin, tailwindcss-lsp, guile-lsp, goblins, etc)</li>
</ul></li>
<li>non root guix can be done through a series of env variables and flags
<ul class="org-ul">
<li>arg <code>--listen=/socket</code> and/or env vars</li>
</ul></li>
<li>app img run <code>mount thing.AppImage tmpmnt -o offset=$(guix shell -C -F zlib -- "./thing.AppImage --appimage-offset")</code></li>
<li>guix shell can emulate normal fs with &#x2013;emulate-fhs</li>
<li>set package as GC root with <code>ln --symbolic --force /path/to/guix/packagelink /var/guix/gcroots</code> for guix copy</li>
<li>download source with <code>guix build -S PKG</code></li>
<li>search with <code>rg -a -z "STR" /gnu/store/PKG.tar.gz</code>
<ul class="org-ul">
<li>Add <code>$XDG_DATA_HOME/guix/bin</code> to <code>$PATH</code></li>
<li><code>--disable-chroot</code></li>
</ul></li>
<li>default source for user is <code>$HOME/.guix-profile/etc/profile</code> and <code>$XDG_CONFIG_HOME/guix/etc/profile</code>
<ul class="org-ul">
<li>cleanup space with <code>guix package -d &amp;&amp; guix pull -d &amp;&amp; guix gc</code></li>
<li>os templates for qemu images with <code>guix system image -t qcow2 --save-provenance</code>
<ul class="org-ul">
<li>guix system upgrade
<ul class="org-ul">
<li><code>ln -s /etc/channels.scm ~/.config/guix/channels.scm</code></li>
<li><code>guix pull</code> <code>. ~/.config/guix/current/etc/profile</code></li>
<li><code>sudo -E guix system reconfigure /etc/guix-os.scm</code></li>
</ul></li>
<li>run guix vm
<ul class="org-ul">
<li><code>qemu-system-x86_64 -nic user,model=virtio-net-pci,hostfwd=tcp::10022-:22 -enable-kvm -m 1024 -device virtio-blk,drive=myhd -drive if=none,file=$MY_IMAGE,id=myhd -spice port=5930,disable-ticketing</code></li>
</ul></li>
<li>grow vm disk
<ul class="org-ul">
<li><code>qemu-image resize IMAGE.qcow2 +10G</code></li>
<li><code>growpart /dev/vda 2</code></li>
<li><code>resize2fs /dev/vda2</code></li>
</ul></li>
</ul></li>
<li><code>guix hash -xr .</code> for the checksum of a repo</li>
<li><code>guix publish</code> substitutes after exporting/importing key with <code>guix archive</code> or use nars with <code>guix archive --export -r</code></li>
</ul></li>
<li>packages are standard SRFI-9 guile records (set-fields, etc&#x2026;)</li>
<li>nonguix substitutes at <code>substitutes.nonguix.org</code> key is <code>/signing-key.pub</code>.</li>
<li><code>guix time-machine --commit=a4eae0c3adce8e4c4ac153a4959d18b9897a67e1 -- package -i old</code></li>
<li>manual setup script <code>GUIX_BINARY_FILE_NAME=guix-binary.tar.xz ./guix-install.sh</code> from <a href="https://guix.gnu.org/install.sh">https://guix.gnu.org/install.sh</a></li>
<li>manual install image
<ul class="org-ul">
<li>create image with <code>guix system image -t iso9660 ./jam/system/installer.scm</code>
<ul class="org-ul">
<li><code>dd if=file.iso of=/dev/sdX status=progress</code></li>
</ul></li>
<li>create wifi.conf with</li>
</ul></li>
</ul>
<div class="org-src-container">
<pre class="src src-conf" id="orge2b3bb6">network={
  ssid="ssid-name"
  key_mgmt=WPA-PSK
  psk="unencrypted passphrase"
}
</pre>
</div>
<ul class="org-ul">
<li><code>rfkill unblock all &amp;&amp; ifconfig -a &amp;&amp; wpa_supplicant -c wifi.conf -i INTERFACE -B &amp;&amp; dhclient -v INTERFACE</code></li>
<li>update time with <code>ntpdate pool.ntp.org</code>
<ul class="org-ul">
<li>if you need to install nss-certs/git set the profile and add gits libexec directory to the PATH</li>
</ul></li>
<li>partition with <code>lsblk &amp;&amp; cfdisk</code></li>
<li>format with mkfs</li>
<li>mount root as mnt and <code>/boot/efi</code> under <code>/mnt/boot/efi</code>
<ul class="org-ul">
<li>ensure to have booted with uefi boot if installing efi and not legacy grub</li>
</ul></li>
<li>swapon the device</li>
<li><code>herd start cow-store /mnt</code></li>
<li>clone config, copy channels to <code>~/.config/guix/</code>, <code>guix pull --no-check-certificate</code> then <code>guix system -L CONFIG_DIR init config.scm /mnt</code></li>
</ul>
<div class="org-src-container">
<pre class="src src-sh" id="org4a90660">guix shell --container --network --emulate-fhs \
    --development ungoogled-chromium gcc:lib \
    --preserve='^DISPLAY$' \
    --preserve='^XAUTHORITY$' --expose=$XAUTHORITY \
    --preserve='^DBUS_' --expose=/var/run/dbus \
    --expose=/sys/dev --expose=/sys/devices --expose=/dev/dri \
    -- ./VSCodium-1.74.0.22342.glibc2.17-x86_64.AppImage --appimage-extract-and-run # Run VSCodium Appimage

guix shell --network --container --emulate-fhs \
    bash coreutils curl grep nss-certs gcc:lib gcc-toolchain \
    pkg-config glib cairo atk pango@1.48.10 gdk-pixbuf gtk+ git \
    --share=$HOME/temphome=$HOME --no-cwd

curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh # install rustup in guix

guix shell --container --network --emulate-fhs \
    --preserve='^DISPLAY$' \
    --preserve='^XAUTHORITY$' --expose=$XAUTHORITY \
    alsa-lib bash coreutils dbus-glib file gcc:lib \
    grep gtk+ libcxx pciutils sed \
    -- ./start-tor-browser.desktop -v ; # Start tor-browser
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh" id="orga4a1137">GUIX_DAEMON_SOCKET=$XDG_DATA_HOME/guix/var/guix/daemon-socket/socket
GUIX_DATABASE_DIRECTORY=$XDG_DATA_HOME/guix/var/guix/db
GUIX_LOG_DIRECTORY=$XDG_DATA_HOME/guix/var/log/guix
GUIX_STATE_DIRECTORY=$XDG_DATA_HOME/guix/var/guix
GUIX_CONFIGURATION_DIRECTORY=$XDG_CONFIG_HOME/guix/etc
GUIX_LOCPATH=$XDG_DATA_HOME/guix/var/guix/profiles/per-user/root/guix-profile/lib/locale
NIX_STORE=$XDG_DATA_HOME/guix/gnu/store
</pre>
</div>

<div class="org-src-container">
<pre class="src src-guile" id="orge0476d8">
(define guix-service ; add type for portable guix package
  (shepherd-service
   (provision '(guix))
   (start #~(make-forkexec-constructor `("guix-daemon" ,(string-append "--listen=" (if (getenv "XDG_DATA_HOME") (getenv "XDG_DATA_HOME")
                                                                                       (string-append (getenv "HOME")
                                                                                                      file-name-separator-string
                                                                                                      ".local"
                                                                                                      file-name-separator-string
                                                                                                      "share"))
                                                                       file-name-separator-string
                                                                       "guix"
                                                                       file-name-separator-string
                                                                       "var"
                                                                       file-name-separator-string
                                                                       "guix"
                                                                       file-name-separator-string
                                                                       "daemon-socket"
                                                                       file-name-separator-string
                                                                       "socket") ;;"--build-users-group=guixbuild"
                                         "--disable-chroot")
                                       #:environment-variables `(,(string-append "NIX_STORE=" (if (getenv "XDG_DATA_HOME")
                                                                                                 (getenv "XDG_DATA_HOME")
                                                                                                  (string-append (getenv "HOME")
                                                                                                                 file-name-separator-string
                                                                                                                 ".local"
                                                                                                                 file-name-separator-string
                                                                                                                 "share"))
                                                                                 file-name-separator-string
                                                                                 "guix"
                                                                                 file-name-separator-string
                                                                                 "gnu"
                                                                                 file-name-separator-string
                                                                                 "store")
                                                                 ,@(environ))))
   (stop #~(make-kill-destructor))
   (auto-start? #f)))

(define ssh-service ; writes to /etc/dropbear for keys
  (set-fields       ; least-authority-wrapper or fork+exec-command/container or run-container to contain
   (car ((@@ (gnu services ssh) dropbear-shepherd-service) (dropbear-configuration (port-number 2222)
                                                                                   (syslog-output? #f)
                                                                                   (password-authentication? #f)
                                                                                   (pid-file "/tmp/dropbear.pid"))))
   ((shepherd-service-requirement) '())
   ((shepherd-service-auto-start?) #f)))
</pre>
</div>
</div>
</div>
</div>
</div>
</body>
</html>
