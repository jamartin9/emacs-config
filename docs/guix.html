<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>guix</title>
<meta name="generator" content="Org Mode" />
<link rel="stylesheet" type="text/css" href="org-default.css" />
</head>
<body>
<div id="content" class="container content">
<nav class="navbar is-black" id="org71f1cbc">
<div class="navbar-brand" id="orgc387ca6">
<div class="navbar-item" id="org0b13830">
<p>
<a href="index.html#ID-3a34d6d7-6f37-4573-b20e-3c93894e54ac">üè†</a>
</p>

</div>

</div>
<div class="navbar-menu" id="org991439a">
<div class="navbar-start" id="orgf88b4ce">
<div class="navbar-item" id="orgb89d930">
<p>
<a href="site_map.html#ID-30ea5e38-9b41-4bcd-8631-76821e93e294">üó∫</a>
</p>

</div>

</div>
<div class="navbar-end" id="org6ee147b">

</div>

</div>
</nav>

<div id="outline-container-org54ee23d" class="outline-2">
<h2 id="org54ee23d">Guix</h2>
<div class="outline-text-2" id="text-org54ee23d">
</div>
<div id="outline-container-orgeec3261" class="outline-3">
<h3 id="orgeec3261">Link manifest and channels</h3>
<div class="outline-text-3" id="text-orgeec3261">
<div class="org-src-container">
<pre class="src src-elisp" id="org3e5fe93">(ignore-errors
(let* ((manifest-dir (file-name-as-directory (concat (if (getenv "XDG_CONFIG_HOME") (file-name-as-directory (getenv "XDG_CONFIG_HOME"))
                                                    (file-name-as-directory (concat (file-name-as-directory (getenv "HOME")) ".config")))
                                                  "guix-manifests")))
        (manifest-dir-file (concat manifest-dir "user.scm")))
    (if (not (file-exists-p manifest-dir))
        (make-directory manifest-dir))
    (if (not (or (file-exists-p manifest-dir-file) (file-symlink-p manifest-dir-file)))
        (make-symbolic-link (concat (file-name-directory (or load-file-name buffer-file-name)) "user.scm") manifest-dir-file 1))))
</pre>
</div>
</div>
</div>
<div id="outline-container-orgf93a79b" class="outline-3">
<h3 id="orgf93a79b">guix home</h3>
<div class="outline-text-3" id="text-orgf93a79b">
<div class="org-src-container">
<pre class="src src-scheme" id="org12b88a7">(use-modules (gnu home)
             (gnu home services)
             (gnu home services guix)
             (gnu home services shells)
             (gnu home services shepherd)
             (gnu services)
             (gnu services ssh)
             (gnu services shepherd)
             (gnu packages)
             (gnu packages admin)
             (srfi srfi-9 gnu)
             (guix channels)
             (gnu packages emacs-xyz)
             (jam packages emacs-xyz)
             (jam packages emacs)
             (guix gexp))

(define emacs-service
  (shepherd-service
   (provision '(emacs))
   (start #~(make-system-constructor "emacs --daemon"))
   (stop #~(make-system-destructor "emacsclient --eval '(kill-emacs)'"))
   (auto-start? #f)))

(define guix-service ; add type for portable guix package
  (shepherd-service
   (provision '(guix))
   (start #~(make-forkexec-constructor `("guix-daemon" ,(string-append "--listen=" (if (getenv "XDG_DATA_HOME") (getenv "XDG_DATA_HOME")
                                                                                       (string-append (getenv "HOME")
                                                                                                      file-name-separator-string
                                                                                                      ".local"
                                                                                                      file-name-separator-string
                                                                                                      "share"))
                                                                       file-name-separator-string
                                                                       "guix"
                                                                       file-name-separator-string
                                                                       "var"
                                                                       file-name-separator-string
                                                                       "guix"
                                                                       file-name-separator-string
                                                                       "daemon-socket"
                                                                       file-name-separator-string
                                                                       "socket") ;;"--build-users-group=guixbuild"
                                         "--disable-chroot")
                                       #:environment-variables `(,(string-append "NIX_STORE=" (if (getenv "XDG_DATA_HOME")
                                                                                                  (getenv "XDG_DATA_HOME")
                                                                                                  (string-append (getenv "HOME")
                                                                                                                 file-name-separator-string
                                                                                                                 ".local"
                                                                                                                 file-name-separator-string
                                                                                                                 "share"))
                                                                                 file-name-separator-string
                                                                                 "guix"
                                                                                 file-name-separator-string
                                                                                 "gnu"
                                                                                 file-name-separator-string
                                                                                 "store")
                                                                 ,@(environ))))
   (stop #~(make-kill-destructor))
   (auto-start? #f)))

(define ssh-service ; writes to /etc/dropbear for keys
  (set-fields       ; make-forkexec-constructor/container to contain
   (car ((@@ (gnu services ssh) dropbear-shepherd-service) (dropbear-configuration (port-number 2222)
                                                                                   (syslog-output? #f)
                                                                                   (password-authentication? #f)
                                                                                   (pid-file "/tmp/dropbear.pid"))))
   ((shepherd-service-requirement) '())
   ((shepherd-service-auto-start?) #f)))

(home-environment
 (packages (append
          ;(map transform-emacs-build (list emacs-rmsbolt emacs-pyvenv emacs-vterm emacs-debbugs emacs-org-roam emacs-flycheck-guile emacs-guix emacs-fd emacs-emms emacs-osm emacs-multiple-cursors emacs-minions emacs-transmission emacs-undo-tree emacs-pass emacs-use-package emacs-code-review emacs-orgit-forge emacs-flycheck-popup-tip emacs-macrostep-geiser emacs-drag-stuff emacs-company emacs-cfrs emacs-lsp-treemacs emacs-lsp-ui emacs-rustic emacs-geiser-guile emacs-dap-mode emacs-link-hint emacs-expand-region emacs-which-key emacs-explain-pause-mode emacs-pcre2el emacs-smartparens emacs-gcmh)) ; BUG no eln
          (map specification-&gt;package (list "guile"
                                           ;"emacs-next-tree-sitter" ; managed by default profile
                                           "fd"
                                           "git"
                                           "ripgrep"
                                           "nss-certs"
                                           "aspell-dict-en"
                                           "mpv"; "vlc"
                                           "gnupg"
                                           "password-store" "pass-otp"
                                           "notification-daemon"
                                           "qemu"
                                           "alacritty"; "xterm"
                                           "curl"; emacs-osm needs for CA's
                                           "screen"
                                           "virt-viewer"; for spice remote-viewer
                                           "python" ; python-lsp
                                           "python-lsp-server"
                                           "python-debugpy"
                                           "tree-sitter-python" "tree-sitter-yaml" ; "tree-sitter-rust"
                                           "emacs-pyvenv" "emacs-vterm" "emacs-debbugs" "emacs-org-roam" "emacs-flycheck-guile" "emacs-rmsbolt" "emacs-guix" "emacs-fd" "emacs-emms" "emacs-osm" "emacs-multiple-cursors" "emacs-minions" "emacs-transmission" "emacs-undo-tree" "emacs-pass" "emacs-password-store-otp" "emacs-code-review" "emacs-orgit-forge" "emacs-flycheck-popup-tip" "emacs-macrostep-geiser" "emacs-drag-stuff" "emacs-company" "emacs-lsp-treemacs" "emacs-lsp-ui" "emacs-rustic" "emacs-geiser-guile" "emacs-dap-mode" "emacs-link-hint" "emacs-expand-region" "emacs-which-key" "emacs-explain-pause-mode" "emacs-pcre2el" "emacs-smartparens" "emacs-gcmh" "emacs-cfrs"
                                           "emacs-use-package" ; "emacs-yaml-mode" ; remove emacs-29
                                           ))))
 (services
  (list
   (simple-service 'my-channel-services
                   home-channels-service-type
                   (list
                    (channel
                     (name 'guix)
                     (url "https://git.savannah.gnu.org/git/guix.git")
                     (introduction
                      (make-channel-introduction
                       "9edb3f66fd807b096b48283debdcddccfea34bad"
                       (openpgp-fingerprint
                        "BBB0 2DDF 2CEA F6A8 0D1D  E643 A2A0 6DF2 A33A 54FA"))))
                    (channel
                     (name 'mychannel)
                     (url "https://github.com/jamartin9/guix-channel");; GUIX_PACKAGE_PATH and (url "file:///home/.../guix-channel")
                     (introduction
                      (make-channel-introduction
                       "a8de09ac62260319e6376f21c995f713c1b09279"
                       (openpgp-fingerprint
                        "34AF BE87 8193 580F F441  AB3F 95AF 699C 293E 302B"))))))
   (service home-shepherd-service-type (home-shepherd-configuration
                                        (shepherd (specification-&gt;package "shepherd"))
                                        ;(auto-start? #f)
                                        (services (list emacs-service
                                                        ;transmission-service
                                                        ;ssh-service
                                                        ;guix-service
                                                        ))))

   (service home-bash-service-type
            (home-bash-configuration
             (package (specification-&gt;package "bash"))
             (guix-defaults? #f)
             ;(environment-variables (list '("EDITOR" . "emacs")))
             (bashrc (list (plain-file "guix.alias" "\
#!/usr/bin/env bash
# shellcheck disable=SC2068,SC1090,SC1091

export TMPDIR=\"/tmp\"

export HISTFILE=\"${XDG_STATE_HOME}\"/bash/history

export CARGO_HOME=\"${XDG_DATA_HOME}\"/cargo
export RUSTUP_HOME=\"${XDG_DATA_HOME}\"/rustup
export GNUPGHOME=\"${XDG_DATA_HOME}\"/gnupg
export PASSWORD_STORE_DIR=\"${XDG_DATA_HOME}\"/pass

export CUDA_CACHE_PATH=\"${XDG_CACHE_HOME}\"/nv
export ICEAUTHORITY=\"${XDG_CACHE_HOME}\"/ICEauthority
export TEXMFVAR=\"${XDG_CACHE_HOME}\"/texlive/texmf-var

export GPG_TTY=$(tty)

export EDITOR=\"emacs\"
alias emacsc=\"emacsclient -c -a ''\"
alias emacskill=\"emacsc -e '(kill-emacs)'\"
_emacs_run_dump(){
    if [ ! -f ~/emp.dmp ]; then
        emacs --batch --eval='(dump-emacs-portable \"~/emp.dmp\")'
    fi
    emacs --dump-file=~/emp.dmp $@
}
alias emrd=\"_emacs_run_dump\"

# Guix parts
alias guixPack=\"guix pack -S /bin=bin -RR\"
alias guixPackDock=\"guix pack -S /bin=bin -f docker\"
alias guixPackVm=\"guix system image -t qcow2\" # qemu-img resize x.qcow +10G boot then growpart and resize2fs

_guix_run_vm(){
    local vmOpts=()
    local qOpts=()
    local target=\"\"
    while [ $# -gt 0 ]; do
        local arg=\"${1}\"
        case \"${arg}\" in
            -d|--default)
                qOpts=(\"-spice\" \"port=5930,disable-ticketing\" \"-m\" \"2048\" \"-nic\" \"user,model=virtio-net-pci,hostfwd=tcp::8080-:8081\" \"${qOpts[@]}\")
                vmOpts=(\"--share=$HOME/tmp=/storage\" \"${vmOpts[@]}\") # --persistent
                shift
                ;;
            -qo|--qopt)
                qOpts=(\"${qOpts[@]}\" \"${2}\")
                shift 2
                ;;
            -t|--target)
                target=\"${2}\"
                shift 2
                ;;
            -vo|--vmopt)
                vmOpts=(\"${vmOpts[@]}\" \"${2}\" )
                shift 2
                ;;
            *)
                printf 'Invalid option %s \n' \"${1}\"
                printf 'Valid options are: -t OS.scm -qo QEMU-OPTS -vo GUIXVM-OPTS --default \n'
                shift
                ;;
        esac
    done
    $(guix system vm \"${vmOpts[@]}\" \"${target}\") \"${qOpts[@]}\"
}
alias guixRunVm=\"_guix_run_vm\" # guixRunVm -d -t os.scm

_guix_vars(){
    if [ -z \"${GUIX_PREV_ENV}\" ]; then # unset vars in guix-home and keep login vars
        export GUIX_PREV_ENV=(\"$(env -u PATH -u GUIX_PROFILE -u GUILE_LOAD_COMPILED_PATH -u GUILE_LOAD_PATH -u SSL_CERT_DIR -u SSL_CERT_FILE -u GIT_EXEC_PATH -u GIT_SSL_CAINFO -u INFOPATH -u EMACSLOADPATH -u EMACSNATIVELOADPATH -u BASH_LOADABLES_PATH -u PASSWORD_STORE_SYSTEM_EXTENSION_DIR -u CURL_CA_BUNDLE PATH=/sbin:/bin:/usr/sbin:/usr/bin bash -c '. /etc/profile &amp;&amp; env')\")
        export GUIX_ACTIVE_PROFILES=()
        # guix-home activated with login shell
        [ -f ~/.guix-home/setup-environment ] &amp;&amp; export GUIX_PREV_ENV_home=(\"$(env)\") &amp;&amp; export GUIX_ACTIVE_PROFILES=(\"home\")
    fi
    if [ -z \"${GUIX_MANIFEST_DIR}\" ]; then
        export GUIX_MANIFEST_DIR=${XDG_CONFIG_DIR:-~/.config}/guix-manifests
    fi
    if [ -z \"${GUIX_EXTRA_PROFILES}\" ]; then
        export GUIX_EXTRA_PROFILES=${XDG_DATA_HOME:-~/.local/share}/guix-extra-profiles
    fi
}
_guix_list_profiles(){
    printf \"The following profiles are available: \n\"
    if [ -f ~/.guix-profile/etc/profile ]; then
        printf \"default \n\"
    fi
    if [ -f ~/.guix-home/profile/etc/profile ]; then
        printf \"home \n\"
    fi
    for manifest in \"${GUIX_MANIFEST_DIR}\"/*.scm; do
        if [ \"${manifest}\" != \"${GUIX_MANIFEST_DIR}/*.scm\" ]; then # no glob
            printf '%s \n' \"$(basename \"${manifest%.*}\")\"
        fi
    done
    printf \"The following profiles are active: \n\"
    for prof in ${GUIX_ACTIVE_PROFILES[@]}; do
        printf '%s \n' \"${prof}\"
    done

}
_guix_update_profile(){
    local arg=\"${1}\"
    local profile=\"${GUIX_EXTRA_PROFILES}/${arg}/${arg}\"
    if [ \"${arg}\" = \"default\" ]; then
        guix package -u
    elif [ \"${arg}\" = \"home\" ]; then
         guix home reconfigure ~/.guix-home/configuration.scm
    elif [ -f \"${GUIX_MANIFEST_DIR}/${arg}.scm\" ]; then
         if [ ! -d \"${profile}\" ]; then
            mkdir -p \"${GUIX_EXTRA_PROFILES}/${arg}\"
         fi
         guix package -m \"${GUIX_MANIFEST_DIR}/${arg}.scm\" -p \"${profile}\"
    fi
}
_guix_activate_profile(){
    local arg=\"${1}\"
    local profile=\"${GUIX_EXTRA_PROFILES}/${arg}/${arg}\"
    if [ \"${arg}\" != \"default\" ] &amp;&amp;
       [ \"${arg}\" != \"home\" ] &amp;&amp;
       [ ! -f \"${profile}\"/etc/profile ]; then # home and default are always installed
        _guix_update_profile \"${arg}\"
    fi
    if [ \"${arg}\" = \"default\" ]; then # unset GUIX_PROFILE so path proliferates
        [ -f ~/.guix-profile/etc/profile ] &amp;&amp; unset GUIX_PROFILE &amp;&amp; . ~/.guix-profile/etc/profile
        [ -f ~/.config/guix/current/etc/profile ] &amp;&amp; unset GUIX_PROFILE &amp;&amp; . ~/.config/guix/current/etc/profile
    elif [ \"${arg}\" = \"home\" ]; then # tilde avoids variables
        [ -f ~/.guix-home/setup-environment ] &amp;&amp; . ~/.guix-home/setup-environment &amp;&amp; export GUIX_PROFILE
    elif [ -f \"${profile}\"/etc/profile ]; then
        unset GUIX_PROFILE &amp;&amp; . \"${profile}\"/etc/profile
    else
        printf 'The manifest for %s does not exist \n' \"${arg}\"
        return
    fi
    local stash=(\"${GUIX_PREV_ENV[@]}\") # hide prev envs from being saved in new GUIX_PREV_ENV_$manifest
    unset GUIX_PREV_ENV
    for mani in ${GUIX_ACTIVE_PROFILES[@]}; do
        local ref=\"GUIX_PREV_ENV_${mani}[@]\"
        local \"stash_${mani}=${!ref}\" # TODO indirect variable expansion portable
        unset \"GUIX_PREV_ENV_${mani}\"
    done
    local prev=(\"$(env)\") # save current env
    export \"GUIX_PREV_ENV_${arg}=${prev[*]}\"
    export GUIX_PREV_ENV=(\"${stash[@]}\") # restore prev envs
    for mani in ${GUIX_ACTIVE_PROFILES[@]}; do
        local ref_stash=\"stash_${mani}\"
        export \"GUIX_PREV_ENV_${mani}=${!ref_stash}\" # TODO indirect variable expansion portable
    done
    GUIX_ACTIVE_PROFILES+=(\"${arg}\")
    export GUIX_ACTIVE_PROFILES
}
_guix_deactivate_profile(){
    local arg=\"${1}\"
    local ref=\"GUIX_PREV_ENV_${arg}\"
    if [ -n \"${!ref}\" ]; then # the prev env exists # TODO indirect variable expansion portable
        for entry in ${!ref}; do # unset vars of profile # TODO indirect variable expansion portable
            if [[ ! \"${entry%%=*}\" =~ GUIX_PREV_ENV.* ]] &amp;&amp;
               [ \"${entry%%=*}\" != \"GUIX_ACTIVE_PROFILES\" ] ;then
                unset \"${entry%%=*}\"
            fi
        done
        unset \"GUIX_PREV_ENV_${arg}\"
        for entry in ${GUIX_PREV_ENV[@]}; do # restore init env
            export \"${entry%%=*}=${entry#*=}\"
        done
        # active manifests again
        local active_stash=(\"${GUIX_ACTIVE_PROFILES[@]}\") # export GUIX_ACTIVE_PROFILES=(\"${GUIX_ACTIVE_PROFILES[@]/$arg}\")
        export GUIX_ACTIVE_PROFILES=() # unset profiles so GUIX_PREV_ENV_${manifest} will not be saved
        for mani in ${active_stash[@]}; do
            if [ \"${mani}\" != \"${arg}\" ]; then
                unset \"GUIX_PREV_ENV_${mani}\" # prevent all GUIX_PREV_ENV_${manifest}'s from being saved
            fi
        done
        for mani in ${active_stash[@]}; do
            if [ \"${mani}\" != \"${arg}\" ]; then
                _guix_activate_profile \"${mani}\"
            fi
        done
    fi
}
_guix_opts(){
    local help=\"
     Takes a list of profile manifest shortnames/commands
     GUIX_MANIFEST_DIR will be set to ${XDG_CONFIG_DIR:-~/.config}/guix-manifests when not set
     GUIX_EXTRA_PROFILES will be set to ${XDG_DATA_HOME:-~/.local/share}/guix-extra-profiles when not set
     GUIX_ACTIVE_PROFILES will be set to the profiles that are activated (in order)
     GUIX_PREV_ENV will be set to contents of env without guix profiles
     GUIX_PREV_ENV_shortname will be set to the contents of env with the profile
     The shortname is the basename
     GUIX_MANIFEST_DIR/shortname.scm is the format of manifest search path
     Profiles besides home/default will be stored under: GUIX_EXTRA_PROFILES/shortname/shortname
     The commands are activate, update, deactivate and list; activate is the default
     -a|--activate shortname -&gt; sources/installs profile; appends to GUIX_ACTIVE_PROFILES
     -d|--deactivate shortname -&gt; restore env before the profile was activated
     -u|--update shortname -&gt; guix package upgrades profile
     -l|--list -&gt; print the contents of GUIX_ACTIVE_PROFILES and GUIX_MANIFEST_DIR (as shortnames)
     -h|--help -&gt; print this message
\"
    _guix_vars
    while [ $# -gt 0 ]; do
        local arg=\"${1}\"
        case \"${arg}\" in
            -a|--activate)
                if [[ \"${GUIX_ACTIVE_PROFILES[*]}\" =~ ${2} ]]; then
                    printf '%s is already active \n' \"${2}\"
                else
                    _guix_activate_profile \"${2}\"
                fi
                shift 2
                ;;
            -d|--deactivate)
                if [[ \"${GUIX_ACTIVE_PROFILES[*]}\" =~ ${2} ]]; then
                    _guix_deactivate_profile \"${2}\"
                    cd . # restore ps1 prompt dir/info
                fi
                shift 2
                ;;
            -h|--help)
                printf '%s' \"${help}\"
                shift
                ;;
            -l|--list)
                _guix_list_profiles
                shift
                ;;
            -u|--update)
                _guix_update_profile \"${2}\"
                shift 2
                ;;
            *)
                if [[ \"${GUIX_ACTIVE_PROFILES[*]}\" =~ ${1} ]]; then
                    printf '%s is already active \n' \"${1}\"
                else
                    _guix_activate_profile \"${1}\"
                fi
                shift
                ;;
        esac
    done
}
alias guixProf=_guix_opts
_guix_opts default"))))))))
</pre>
</div>
</div>
</div>

<div id="outline-container-org60d70d0" class="outline-3">
<h3 id="org60d70d0">guixsd config</h3>
<div class="outline-text-3" id="text-org60d70d0">
<div class="org-src-container">
<pre class="src src-scheme" id="org02c1b9d">
(use-modules
 (gnu)
 (gnu services)
 (gnu services linux)
 (gnu services shepherd)
 (gnu services file-sharing)
 (gnu services networking)
 (gnu services sysctl)
 (gnu services vpn)
 (gnu packages networking)
 (gnu packages containers)
 (guix)
 (guix gexp)
 (guix packages)
 (srfi srfi-1)
 (jam packages zfs)
 (nongnu packages linux)
 (nongnu system linux-initrd)
 )

(use-service-modules desktop mcron networking spice ssh xorg sddm cuirass)
(use-package-modules bootloaders certs fonts nvi
                     package-management wget xorg
                     ;; ZFS
                     linux file-systems admin)
;; broadcom service
(define broadcom-service-type
  (service-type
   (name 'broadcom)
   (extensions
    (list
     ;; add kernel module
     (service-extension linux-loadable-module-service-type
                               (const (list broadcom-sta)))
      ;; load kernel module
     (service-extension kernel-module-loader-service-type
                               (const '("wl")))))
   (default-value '())
   (description "Install broadcom kernel module and service")))
;; * TODO guix nvidia-driver(xorg/ko), tor/i2p service

(define my-kernel (corrupt-linux linux-libre-with-bpf))

(operating-system
  (host-name "gnu")
  (timezone "Etc/UTC")
  (locale "en_US.utf8")
  (keyboard-layout (keyboard-layout "us" "altgr-intl"))

  (kernel linux-libre-with-bpf); my-kernel
  ;(initrd microcode-initrd)
  ;(kernel-arguments '("modprobe.blacklist=b43,b43legacy,ssb,bcm43xx,brcm80211,brcmfmac,brcmsmac,bcma,nouveau"))

  ;; Label for the GRUB boot menu.
  (label (string-append "GNU Guix " (package-version guix)))

  ;(firmware (list linux-firmware))

  ;; Below we assume /dev/vda is the VM's hard disk.
  ;; Adjust as needed.
  (bootloader (bootloader-configuration
               (bootloader grub-bootloader)
               (targets '("/dev/vda"))
               (terminal-outputs '(console))))

  (file-systems (cons (file-system
                        (mount-point "/")
                        (device "/dev/vda1")
                        (options "compress=zstd,space_cache=v2")
                        (type "btrfs"))
                      %base-file-systems))

  (users (cons (user-account
                (name "guest")
                (comment "GNU Guix Live")
                (password "")                     ;no password
                (group "users")
                (supplementary-groups '("wheel" "netdev"
                                        "audio" "video")))
               %base-user-accounts))

  ;; Our /etc/sudoers file.  Since 'guest' initially has an empty password,
  ;; allow for password-less sudo.
  (sudoers-file (plain-file "sudoers" "\
root ALL=(ALL) ALL
%wheel ALL=NOPASSWD: ALL\n"))

  (packages (append (list font-bitstream-vera nss-certs nvi wget cloud-utils); cloud-utils for growpart with resize2fs after img resize
                    %base-packages)) ; podman flatpak blueman

  (services
   (append (list (service xfce-desktop-service-type)

                 ;; Choose SLiM, which is lighter than the default GDM.
                 (service slim-service-type
                          (slim-configuration
                           (auto-login? #t)
                           (default-user "guest")
                           (xorg-configuration
                            (xorg-configuration
                             ;; The QXL virtual GPU driver is added to provide
                             ;; a better SPICE experience.
                             (modules (cons xf86-video-qxl
                                            %default-xorg-modules))
                             (keyboard-layout keyboard-layout)))))

                 ;(service bluetooth-service-type
                 ;         (bluetooth-configuration
                 ;          (auto-enable? #f)))

                 ;(service broadcom-service-type)

                 (service openssh-service-type
                          (openssh-configuration (%auto-start? #f)
                                                 (port-number 8081)
                                                 (password-authentication? #f)
                                                 (authorized-keys `(("guest" ,(plain-file "jam.pub" "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAILjfouQY9m8opK3Sq5G81FuqlMEa5no1Jy1UywweZY3u jam@jam-pc"))))
                                                 ))

                 ;(service cuirass-service-type
                 ;         (cuirass-configuration (specifications #~(list (specification
                 ;                                                         (name "my-channel-packages")
                 ;                                                         (build '(packages "emacs-cfrs"))
                 ;                                                         (build '(channels my-channel))
                 ;                                                         (channels (cons (channel
                 ;                                                                          (name 'my-channel)
                 ;                                                                          (url "https://github.com/jamartin9/guix-channel.git"))
                 ;                                                                         %default-channels))
                                                                          ;(period 600)
                                                                          ;(build-outputs (list
                                                                          ;                (build-output
                                                                          ;                 (job "hello*")
                                                                          ;                 (type "archive")
                                                                          ;                 (output "out")
                                                                          ;                 (path ""))))
                 ;                                                         )))
                 ;                                (use-substitutes? #t)
                 ;                                (host "0.0.0.0")))

                 (simple-service 'os-file etc-service-type
                                 (list `("guix-os.scm" ,(local-file "guix-os.scm"))))

                 (simple-service 'channel-file etc-service-type ; TODO remove after guix-home integrated
                                 (list `("channels.scm" ,(local-file "channels.scm"))))

                 ;(service zfs-service-type
                 ;         (zfs-configuration
                 ;          (kernel my-kernel)))

                 (service nftables-service-type
                          (nftables-configuration
                           (ruleset (plain-file "nftables.conf" "# Firewall hook order is: prerouting -&gt; input/output/forward -&gt; postrouting
# flush all the rules.
flush ruleset
# Define vars.
#define wan = eno1
define wan = eth0
define vpn = wg0
define vpn_net = 10.0.0.1/24
define router = 192.168.1.1

table inet nat {
  chain prerouting {
    type nat hook prerouting priority -100;
  }
  chain postrouting {
    type nat hook postrouting priority 100;
    oifname $wan ip saddr $vpn_net masquerade
  }
}
table inet filter {
  chain input {
    type filter hook input priority 0; policy drop;

    # early drop of invalid connections
    ct state invalid drop

    # allow established/related connections
    ct state { established, related } accept

    # allow from loopback
    iifname lo accept

    # drop icmp
    ip protocol icmp drop
    ip6 nexthdr icmpv6 drop

    # allow ssh
    tcp dport 8081 accept

    # allow spice
    tcp dport 5930 accept

    # allow transmission
    #tcp dport 51413 accept

    # allow ssdp, pcp and nat-pmp port mapping
    udp sport 1900 udp dport &gt;= 1024 meta pkttype unicast limit rate 4/second burst 20 packets accept comment \"Accept UPnP IGD port mapping reply\"
    udp sport 1900 ip saddr $router accept
    udp sport 5350 ip saddr $router accept
    udp sport 5351 ip saddr $router accept

    # allow monerod
    #tcp dport 18080 accept

    # allow p2pool
    #tcp dport 37889 accept

    # allow cuirass
    #tcp dport 8080 accept

    # allow wireguard peers to connect to each other
    iifname $vpn accept
    udp dport 51820 accept
    iifname $vpn oifname $vpn ct state new accept

    # allow dhcp
    udp sport bootpc udp dport bootps ip saddr 0.0.0.0 ip daddr 255.255.255.255 accept comment \"Accept DHCPDISCOVER (for DHCP-Proxy)\"

    # allow mdns
    udp dport mdns ip6 daddr ff02::fb accept comment \"Accept mDNS\"
    udp dport mdns ip daddr 224.0.0.251 accept comment \"Accept mDNS\"

    # reject everything else
    reject with icmpx type port-unreachable
  }
  chain forward {
    type filter hook forward priority 0; policy drop;

    # drop invalid packets
    ct state invalid drop

    # forward established connections
    ct state established,related accept

    # forward wireguard to wan
    iifname $vpn oifname $wan ct state new accept
  }
  chain output {
    type filter hook output priority 0; policy accept;
  }
}"))))

                ; (service transmission-daemon-service-type
                ;          (transmission-daemon-configuration
                ;           ;(peer-port 51413)
                ;           (port-forwarding-enabled? #f)
                ;           (dht-enabled? #f)
                ;           (pex-enabled? #f)
                ;           (rpc-whitelist '("127.0.0.1" "::1" "10.0.0.*"))))

                 (service wireguard-service-type
                          (wireguard-configuration
                           (addresses '("10.0.0.5/32"))
                           ;(port 51820)
                           ;(private-key "/etc/wiregaurd/private.key"); autogened if doesn't exist
                           (peers (list
                                   (wireguard-peer
                                    (name "my-peer")
                                    ;(endpoint "somesuchendpoint")
                                    (public-key "k+ZFm8brFtuVOLUpjQVYdHrCEC5SakGistFjucQa7l4=")
                                    ;(preshared-key "k+ZFm8brFtuVOLUpjQVYdHrCEC5SakGistFjucQa7l4=")
                                    (allowed-ips '("10.0.0.1/24")))))))

                 ;; Add support for the SPICE protocol, which enables dynamic
                 ;; resizing of the guest screen resolution, clipboard
                 ;; integration with the host, etc.
                 (service spice-vdagent-service-type)

                 ;; Use the DHCP client service rather than NetworkManager.
                 (service dhcp-client-service-type))

           ;; Remove some services that don't make sense in a VM.
           (remove (lambda (service)
                     (let ((type (service-kind service)))
                       (or (memq type
                                 (list gdm-service-type
                                       sddm-service-type
                                       wpa-supplicant-service-type
                                       cups-pk-helper-service-type
                                       network-manager-service-type
                                       modem-manager-service-type))
                           (eq? 'network-manager-applet
                                (service-type-name type)))))
                   (modify-services %desktop-services
                     (sysctl-service-type config =&gt;
                                          (sysctl-configuration
                                           (settings (append '(("net.ipv4.ip_forward" . "1")
                                                               ("net.ipv6.conf.all.forwarding" . "1"))
                                                             %default-sysctl-settings))))
                     (guix-service-type config =&gt;
                                         (guix-configuration
                                          (inherit config)
                                          (log-compression 'none); use btrfs compression
                                          (guix (current-guix))
                                          (substitute-urls
                                 (append (list "https://substitutes.nonguix.org/"); 4zwzi66wwdaalbhgnix55ea3ab4pvvw66ll2ow53kjub6se4q2bclcyd.onion
                                         %default-substitute-urls)) ;(http-proxy) with tor config HTTPTunnelPort
                                          (authorized-keys
                                 (append (list (local-file "./nonguix-pub.scm"))
                                         %default-authorized-guix-keys))))))))

  ;; Allow resolution of '.local' host names with mDNS.
  (name-service-switch %mdns-host-lookup-nss))
</pre>
</div>
</div>
</div>
<div id="outline-container-orge4c02df" class="outline-3">
<h3 id="orge4c02df">User manifest</h3>
<div class="outline-text-3" id="text-orge4c02df">
<div class="org-src-container">
<pre class="src src-scheme" id="org8fd5b5b">;; Manifest for development env
(specifications-&gt;manifest
 '(
   ;; basic
   ;;"emacs-pgtk-native-comp" ;;"git" ;;"ripgrep" ;;"fd" ;;"nss-certs" ;;"guix" ;;"guile" ;;"shepherd" ;;"glibc-utf8-locales"

   ;;"ungoogled-chromium-nvda"
   ;;"firefox-nvda"

   ;;"transmission"
   ;;"nzbget"
   ;;"steam-nvidia" ;; steam
   ;;"zfs"
   "qemu"
   "perf"
   "bpftrace"
   "bcc"

   ;; C dev
   ;;"make" ;;"cmake"
   ;;"glibc" ;; "musl"
   ;;"gcc-toolchain" ;;"clang-toolchain"
   ;;"gdb" ;;"lldb"
   "rr"
   ;;"binutils"
   ;;"module-init-tools"
   ;;"msr-tools"

   ;; java
   ;;"openjdk"
   ;;"maven"
   ;;"leiningen"
   ;;"clojure"

   ;; julia
   ;;"julia"

   ;; python
   ;;"python"

   ;; shell
   "shellcheck" ;;"bash"
   "htop"
   ;;"xclip"
   ;;"wl-clipboard"
   ;;"bc"
   ;;"jq"
   ;;"coreutils" ;;"busybox"
   ;;"less"
   ;;"gzip"
   ;;"fdisk" ;;"gparted"
   ;;"wget"
   ;;"diffutils"
   ;;"findutils"
   ;;"tar"
   ;;"gawk"
   ;;"which"
   ;;"sed"
   ;;"grep"
   ;;"patch"
   ;;"gash"
   ;;"gash-utils"
   ;;"gnupg"
   ;;"password-store"

   ;; apps
   ;;"wine64"; "wine"
   ;;"winetricks"
   ;;"clamav"
   ;;"filezilla"
   ;;"lynx"
   ;;"libvirt"
   ;;"virt-manager"
   ;;"postgresql"
   ;;"sqlite"
   ;;"tigervnc-client"
   ;;"tigervnc-server"
   ;;"searx"
   ;;"gnuradio"
   ;;"obs"
   ;;"virt-viewer"

   ;; docs
   ;;"libreoffice"
   ;;"calibre"
   ;;"biber"
   ;;"texlive"
   ;;"kiwix-desktop"

   ;; media
   ;;"blender"
   ;;"gimp"
   ;;"inkscape"
   ;;"vlc"
   ;;"mkvtoolnix"
   ;;"mediainfo"
   ;;"ffmpeg"
   ;;"gnuplot"
   ;;"makemkv"
   "flamegraph"
   ;;"yt-dlp"

   ;; net
   ;;"curl"
   ;;"whois"
   ;;"bind:utils"
   ;;"nmap"
   ;;"python-stem"
   ;;"onionshare"
   ;;"iptables"
   ;;"ebtables"
   "wireshark"
   ;;"netcat"
   ;;"net-tools"
   ;;"openssh" ;;"dropbear"
   ;;"wireguard-tools"
   ;;"socat"
   "strace"
   ;;"tor"
   "torsocks"
   ;;"i2pd"
   ;;"screen"
   "dnsmasq"

   ;; Desktop
   ;;"xfce"; --with-graft=mesa=nvda
   ;;"nvidia-driver"; add udev rules, mesa graft and xorg modules rules
   ))
</pre>
</div>
</div>
</div>
<div id="outline-container-orga0a51d5" class="outline-3">
<h3 id="orga0a51d5">Channel configuration</h3>
<div class="outline-text-3" id="text-orga0a51d5">
<div class="org-src-container">
<pre class="src src-scheme" id="org280670b">(list (channel
       ;; custom guix override
       (name 'guix)
       (url "https://git.savannah.gnu.org/git/guix.git")
       (introduction
        (make-channel-introduction
         "9edb3f66fd807b096b48283debdcddccfea34bad"
         (openpgp-fingerprint
          "BBB0 2DDF 2CEA F6A8 0D1D  E643 A2A0 6DF2 A33A 54FA"))))
      (channel
       ;; GUIX_PACKAGE_PATH and (url "file:///home/.../guix-channel")
       (name 'mychannel)
       (url "https://github.com/jamartin9/guix-channel")
       (introduction
        (make-channel-introduction
         "a8de09ac62260319e6376f21c995f713c1b09279"
         (openpgp-fingerprint
          "34AF BE87 8193 580F F441  AB3F 95AF 699C 293E 302B")))))

</pre>
</div>
</div>
</div>
<div id="outline-container-orgf34d959" class="outline-3">
<h3 id="orgf34d959">non guix key</h3>
<div class="outline-text-3" id="text-orgf34d959">
<div class="org-src-container">
<pre class="src src-scheme" id="orgbcb2327">(public-key
 (ecc
  (curve Ed25519)
  (q #C1FD53E5D4CE971933EC50C9F307AE2171A2D3B52C804642A7A35F84F3A4EA98#)
  )
 )
</pre>
</div>
</div>
</div>
<div id="outline-container-orgfd7df93" class="outline-3">
<h3 id="orgfd7df93">guix notes</h3>
<div class="outline-text-3" id="text-orgfd7df93">
<ul class="org-ul">
<li>transform options for source, c-toolchain, debug, grafts/inputs
<ul class="org-ul">
<li><code>--with-commit=SomeSuchPackage=XXX</code></li>
</ul></li>
<li><code>-L ./guix-channel</code> to use local channel changes</li>
<li><code>guix pack -S /bin=bin -S /sbin=sbin --localstatedir -RR guix bash-static</code></li>
<li><code>guix package --roll-back</code> to drop to last version</li>
<li>commit signing and downgrading flags are <code>--disable-authentication --allow-downgrades</code></li>
<li>platform specific binaries can be produces with the <code>--tune</code> flag</li>
<li>hpc channel for extra pytorch packages
<ul class="org-ul">
<li><a href="https://gitlab.inria.fr/guix-hpc/guix-hpc/">https://gitlab.inria.fr/guix-hpc/guix-hpc/</a></li>
</ul></li>
<li>non root guix can be done through a series of env variables and flags
<ul class="org-ul">
<li>arg <code>--listen=/socket</code> and/or env vars</li>
</ul></li>
<li>app img run <code>mount thing.AppImage tmpmnt -o offset=$(guix shell -C -F zlib -- "./thing.AppImage --appimage-offset")</code></li>
<li>guix shell can emulate normal fs with &#x2013;emulate-fhs</li>
</ul>
<div class="org-src-container">
<pre class="src src-sh" id="org9761d47">guix shell --container --network --emulate-fhs \
    --development ungoogled-chromium gcc:lib \
    --preserve='^DISPLAY$' \
    --preserve='^XAUTHORITY$' --expose=$XAUTHORITY \
    --preserve='^DBUS_' --expose=/var/run/dbus \
    --expose=/sys/dev --expose=/sys/devices --expose=/dev/dri \
    -- ./VSCodium-1.74.0.22342.glibc2.17-x86_64.AppImage --appimage-extract-and-run # Run VSCodium Appimage

guix shell --network --container --emulate-fhs \
    bash coreutils curl grep nss-certs gcc:lib gcc-toolchain \
    pkg-config glib cairo atk pango@1.48.10 gdk-pixbuf gtk+ git \
    --share=$HOME/temphome=$HOME --no-cwd

curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh # install rustup in guix

guix shell --container --network --emulate-fhs \
    --preserve='^DISPLAY$' \
    --preserve='^XAUTHORITY$' --expose=$XAUTHORITY \
    alsa-lib bash coreutils dbus-glib file gcc:lib \
    grep gtk+ libcxx pciutils sed \
    -- ./start-tor-browser.desktop -v ; # Start tor-browser
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh" id="orga71a5f5">GUIX_DAEMON_SOCKET=$XDG_DATA_HOME/guix/var/guix/daemon-socket/socket
GUIX_DATABASE_DIRECTORY=$XDG_DATA_HOME/guix/var/guix/db
GUIX_LOG_DIRECTORY=$XDG_DATA_HOME/guix/var/log/guix
GUIX_STATE_DIRECTORY=$XDG_DATA_HOME/guix/var/guix
GUIX_CONFIGURATION_DIRECTORY=$XDG_CONFIG_HOME/guix/etc
GUIX_LOCPATH=$XDG_DATA_HOME/guix/var/guix/profiles/per-user/root/guix-profile/lib/locale
NIX_STORE=$XDG_DATA_HOME/guix/gnu/store
</pre>
</div>
<ul class="org-ul">
<li>Add <code>$XDG_DATA_HOME/guix/bin</code> to <code>$PATH</code></li>
<li><code>--disable-chroot</code></li>
</ul>
<ul class="org-ul">
<li>default source for user is <code>$HOME/.guix-profile/etc/profile</code> and <code>$XDG_CONFIG_HOME/guix/etc/profile</code></li>
<li>cleanup space with <code>guix package -d &amp;&amp; guix pull -d &amp;&amp; guix gc</code></li>
<li>os templates for qemu images with <code>guix system image -t qcow2 --save-provenance</code>
<ul class="org-ul">
<li><code>qemu-system-x86_64 -nic user,model=virtio-net-pci,hostfwd=tcp::10022-:22 -enable-kvm -m 1024 -device virtio-blk,drive=myhd -drive if=none,file=$MY_IMAGE,id=myhd -spice port=5930,disable-ticketing</code></li>
<li><code>qemu-image resize IMAGE.qcow2 +10G</code></li>
</ul></li>
<li><code>guix hash -xr .</code> for the checksum of a repo</li>
<li><code>guix publish</code> substitutes after exporting/importing key with <code>guix archive</code> or use nars with <code>guix archive --export -r</code></li>
</ul>
<div class="org-src-container">
<pre class="src src-sh" id="org8512898">guix time-machine --commit=a4eae0c3adce8e4c4ac153a4959d18b9897a67e1 -- package -i old
</pre>
</div>
<ul class="org-ul">
<li>nonguix substitutes at <code>substitutes.nonguix.org</code> key is <code>/signing-key.pub</code>.</li>
<li><p>
manual setup
</p>
<div class="org-src-container">
<pre class="src src-shell" id="org08fadda">#https://git.savannah.gnu.org/cgit/guix.git/plain/etc/guix-install.sh
# get tarball for system=x86_64-linux,aarch64,armhf,i686
wget https://ftp.gnu.org/gnu/guix/guix-binary-1.0.1.x86_64-linux.tar.xz
# check sig
wget https://sv.gnu.org/people/viewgpg.php?user_id=15145 -qO - | gpg --import
wget https://ftp.gnu.org/gnu/guix/guix-binary-1.0.1.x86_64-linux.tar.xz.sig
gpg --verify guix-binary-1.0.1.x86_64-linux.tar.xz.sig
# with root
sudo -i
# untar into dirs
tar --warning=no-timestamp -xf /path/to/guix-binary-1.0.1.x86_64-linux.tar.xz
mv var/guix /var/ &amp;&amp; mv gnu /
# add guix profile
mkdir -p ~root/.config/guix
ln -sf /var/guix/profiles/per-user/root/current-guix ~root/.config/guix/current
# setup build daemon for multiple users
cp ~root/.config/guix/current/lib/systemd/system/guix-daemon.service /etc/systemd/system/
# add build users
groupadd --system guixbuild
for i in `seq -w 1 10`;
do
    useradd -g guixbuild -G guixbuild           \
            -d /var/empty -s `which nologin`    \
            -c "Guix build user $i" --system    \
            guixbuilder$i;
done
# link guix and info for all users
mkdir -p /usr/local/bin
cd /usr/local/bin
ln -s /var/guix/profiles/per-user/root/current-guix/bin/guix
mkdir -p /usr/local/share/info
cd /usr/local/share/info
for i in /var/guix/profiles/per-user/root/current-guix/share/info/* ;
do ln -s $i ; done
# source guix profile and add sub servers
source ~/root/.config/guix/current/etc/profile
guix archive --authorize &lt; ~root/.config/guix/current/share/guix/ci.guix.gnu.org.pub
guix archive --authorize &lt; ~root/.config/guix/current/share/guix/bordeaux.guix.gnu.org.pub
# install locale
guix package -i glibc-utf8-locales
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-org920696a" class="outline-3">
<h3 id="org920696a">guix issues</h3>
<div class="outline-text-3" id="text-org920696a">
</div>
<div id="outline-container-org9c9b7c7" class="outline-4">
<h4 id="org9c9b7c7"><span class="todo TODO">TODO</span> [PATCH v1] initrd: Allow extra search paths with ‚Äòinitrd-extra-module-paths‚Äô&#xa0;&#xa0;&#xa0;<span class="tag"><span class="patch">patch</span></span></h4>
<div class="outline-text-4" id="text-org9c9b7c7">
<p>
<span class="timestamp-wrapper"><span class="timestamp">[2022-05-02 Mon] </span></span> Submitted
</p>
<p>
:DEBBUGS<sub>ID</sub>: 55231
:CREATOR: Brian Cully &lt;bjc@spork.org&gt;
</p>
<p>
<a href="(progn (debbugs-org-mode 1) (debbugs-gnu-select-report))">Messages</a>
<span class="timestamp-wrapper"><span class="timestamp">[2022-06-21 Tue] </span></span> Last modified
</p>
</div>
</div>
<div id="outline-container-orgac89ec0" class="outline-4">
<h4 id="orgac89ec0"><span class="todo TODO">TODO</span> Support binaries that need "setcap" similar to "setuid-programs"</h4>
<div class="outline-text-4" id="text-orgac89ec0">
<p>
<span class="timestamp-wrapper"><span class="timestamp">[2022-05-27 Fri] </span></span> Submitted
</p>
<p>
:DEBBUGS<sub>ID</sub>: 55683
:CREATOR: Vagrant Cascadian &lt;vagrant@debian.org&gt;
</p>
<p>
<a href="(progn (debbugs-org-mode 1) (debbugs-gnu-select-report))">Messages</a>
<span class="timestamp-wrapper"><span class="timestamp">[2022-05-27 Fri] </span></span> Last modified
</p>
</div>
</div>
</div>

<div id="outline-container-org2405d47" class="outline-3">
<h3 id="org2405d47">guix pending packages</h3>
<div class="outline-text-3" id="text-org2405d47">
</div>
<div id="outline-container-org23bab69" class="outline-4">
<h4 id="org23bab69"><span class="todo TODO">TODO</span> add guix package for mpv with libvdpau-nvidia from nvidia-libs nonguix</h4>
<div class="outline-text-4" id="text-org23bab69">
</div>
<ul class="org-ul">
<li><a id="orgfc1a8f5"></a><span class="todo TODO">TODO</span> add guix package for alacritty with nvidia-libs<br></li>
<li><a id="org881fbe9"></a><span class="todo TODO">TODO</span> add guix package for httm<br>
<div class="outline-text-5" id="text-org881fbe9">
<ul class="org-ul">
<li>rust version too old with cargo-build-system</li>
</ul>
</div>
</li>
<li><a id="orgf65f555"></a><span class="todo TODO">TODO</span> add guix package for btm<br>
<div class="outline-text-5" id="text-orgf65f555">
<ul class="org-ul">
<li>rust version issue with rust-parking-lot dep</li>
</ul>
</div>
</li>
<li><a id="org834d015"></a><span class="todo TODO">TODO</span> add guix package for opensnitch<br>
<div class="outline-text-5" id="text-org834d015">
<ul class="org-ul">
<li>import needs step added for protoc header generation</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
</body>
</html>