<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>guix</title>
<meta name="generator" content="Org Mode" />
<link rel="stylesheet" type="text/css" href="org-default.css" />
</head>
<body>
<div id="content" class="container">
<nav aria-label="breadcrumb" style="--pico-nav-breadcrumb-divider: '|';" id="org0c41d30">
<ul class="org-ul">
<li><a href="index.html#ID-3a34d6d7-6f37-4573-b20e-3c93894e54ac">üè†</a></li>
<li><a href="site_map.html#ID-30ea5e38-9b41-4bcd-8631-76821e93e294">üó∫</a></li>
</ul>
</nav>

<div id="outline-container-orgb4eaa13" class="outline-2">
<h2 id="orgb4eaa13">Guix</h2>
<div class="outline-text-2" id="text-orgb4eaa13">
</div>
<div id="outline-container-orgcd93e65" class="outline-3">
<h3 id="orgcd93e65">Link manifest</h3>
<div class="outline-text-3" id="text-orgcd93e65">
<div class="org-src-container">
<pre class="src src-elisp" id="org35a9f45">(ignore-errors
(let* ((manifest-dir (file-name-as-directory (concat (file-name-as-directory (xdg-config-home)) "guix-manifests")))
        (manifest-dir-file (concat manifest-dir "user.scm")))
    (if (not (file-exists-p manifest-dir))
        (make-directory manifest-dir))
    (if (not (or (file-exists-p manifest-dir-file) (file-symlink-p manifest-dir-file)))
        (make-symbolic-link (concat (file-name-directory (or load-file-name buffer-file-name)) "user.scm") manifest-dir-file 1))))
</pre>
</div>
</div>
</div>
<div id="outline-container-org947d138" class="outline-3">
<h3 id="org947d138">User manifest</h3>
<div class="outline-text-3" id="text-org947d138">
<div class="org-src-container">
<pre class="src src-scheme" id="org876f218">;; Manifest for development env
(specifications-&gt;manifest
 '(
   ;; basic
   ;;"shepherd" ;;"glibc-utf8-locales"

   ;;"ungoogled-chromium-nvda"
   ;;"firefox-nvda"; --with-graft=mesa=nvda
   ;;"torbrowser"

   ;;"transmission"
   ;;"nzbget"
   ;;"steam-nvidia" ;; steam
   ;;"zfs"
   "perf"
   "bpftrace"
   "bcc"

   ;; C dev
   ;;"make" ;;"cmake"
   ;;"glibc" ;; "musl"
   ;;"gcc-toolchain" ;;"clang-toolchain"
   ;;"gdb" ;;"lldb"
   "rr"
   ;;"binutils"
   ;;"module-init-tools"
   ;;"msr-tools"

   ;; java
   ;;"openjdk"
   ;;"maven"
   ;;"leiningen"
   ;;"clojure"

   ;; julia
   ;;"julia"

   ;; python
   ;;"python"

   ;; shell
   ;;"shellcheck" ;;"bash"
   "htop"
   ;;"xclip"
   ;;"wl-clipboard"
   ;;"bc"
   ;;"jq"
   ;;"coreutils" ;;"busybox"
   ;;"less"
   ;;"gzip"
   ;;"fdisk" ;;"gparted"
   ;;"wget"
   ;;"diffutils"
   ;;"findutils"
   ;;"tar"
   ;;"gawk"
   ;;"which"
   ;;"sed"
   ;;"grep"
   ;;"patch"
   ;;"gash"
   ;;"gash-utils"

   ;; apps
   ;;"wine64"; "wine"
   ;;"winetricks"
   ;;"clamav"
   ;;"filezilla"
   ;;"lynx"
   ;;"libvirt"
   ;;"virt-manager"
   ;;"postgresql"
   ;;"sqlite"
   ;;"tigervnc-client"
   ;;"tigervnc-server" ; newer gdm supports rdp login
   ;;"searx"
   ;;"gnuradio"
   ;;"obs"
   ;;"virt-viewer"
   ;;"dino" ; xmpp client
   ;;"flatpak"

   ;; docs
   ;;"libreoffice"
   ;;"calibre"
   ;;"biber"
   ;;"texlive"
   ;;"kiwix-desktop"

   ;; media
   ;;"blender"
   ;;"gimp"
   ;;"inkscape"
   ;;"vlc"
   ;;"mkvtoolnix"
   ;;"mediainfo"
   ;;"ffmpeg"
   ;;"gnuplot"
   ;;"makemkv"
   "flamegraph"
   ;;"yt-dlp"
   ;;"vapoursynth";; "ffms2"

   ;; net
   ;;"curl"
   ;;"whois"
   ;;"bind:utils"
   ;;"nmap"
   ;;"python-stem"
   ;;"onionshare"
   ;;"iptables"
   ;;"ebtables"
   "wireshark"
   ;;"netcat"
   ;;"net-tools"
   ;;"openssh" ;;"dropbear"
   ;;"wireguard-tools"
   ;;"socat"
   "strace"
   ;;"tor"
   "torsocks"
   ;;"i2pd"
   ;;"screen"
   "dnsmasq"

   ;; Desktop
   ;;"notification-daemon"
   ;;"nvidia-driver"
   ))
</pre>
</div>
</div>
</div>
<div id="outline-container-org761e1f5" class="outline-3">
<h3 id="org761e1f5">guix notes</h3>
<div class="outline-text-3" id="text-org761e1f5">
<ul class="org-ul">
<li><a href="https://git.genenetwork.org/guix-north-america/about/">https://git.genenetwork.org/guix-north-america/about/</a> for NA substitute server ?</li>
<li>cuirass ci saves gc roots in <code>/var/guix/gcroots/profiles/per-user/cuirass/cuirass</code> for default of 30 days
<ul class="org-ul">
<li>can unlink and gc for space</li>
</ul></li>
<li><code>guix system image -t iso9660 ./installer.scm</code></li>
<li><code>GUIX_SANDBOX_EXTRA_MOUNTS=/path/to/extra/thing</code> for guix steam</li>
<li>transform options for source, c-toolchain, debug, grafts/inputs
<ul class="org-ul">
<li><code>--with-commit=SomeSuchPackage=XXX</code></li>
</ul></li>
<li><code>-L ./guix-channel</code> to use local channel changes</li>
<li><code>guix pack -S /bin=bin -S /sbin=sbin --localstatedir -RR guix bash-static</code></li>
<li><code>guix package --roll-back</code> to drop to last version</li>
<li>commit signing and downgrading flags are <code>--disable-authentication --allow-downgrades</code></li>
<li>platform specific binaries can be produces with the <code>--tune</code> flag</li>
<li>hpc channel for extra pytorch packages
<ul class="org-ul">
<li><a href="https://gitlab.inria.fr/guix-hpc/guix-hpc/">https://gitlab.inria.fr/guix-hpc/guix-hpc/</a></li>
<li>misc channels <a href="https://git.sr.ht/~whereiseveryone/toys/log">https://git.sr.ht/~whereiseveryone/toys/log</a></li>
</ul></li>
<li>non root guix can be done through a series of env variables and flags
<ul class="org-ul">
<li>arg <code>--listen=/socket</code> and/or env vars</li>
</ul></li>
<li>app img run <code>mount thing.AppImage tmpmnt -o offset=$(guix shell -C -F zlib -- "./thing.AppImage --appimage-offset")</code></li>
<li>guix shell can emulate normal fs with &#x2013;emulate-fhs</li>
<li>set package as GC root with <code>ln --symbolic --force /path/to/guix/packagelink /var/guix/gcroots</code> for guix copy</li>
<li>download source with <code>guix build -S PKG</code></li>
<li>search with <code>rg -a -z "STR" /gnu/store/PKG.tar.gz</code>
<ul class="org-ul">
<li>Add <code>$XDG_DATA_HOME/guix/bin</code> to <code>$PATH</code></li>
<li><code>--disable-chroot</code></li>
</ul></li>
<li>default source for user is <code>$HOME/.guix-profile/etc/profile</code> and <code>$XDG_CONFIG_HOME/guix/etc/profile</code>
<ul class="org-ul">
<li>cleanup space with <code>guix package -d &amp;&amp; guix pull -d &amp;&amp; guix gc</code></li>
<li>os templates for qemu images with <code>guix system image -t qcow2 --save-provenance</code>
<ul class="org-ul">
<li>guix system upgrade
<ul class="org-ul">
<li><code>ln -s /etc/channels.scm ~/.config/guix/channels.scm</code></li>
<li><code>guix pull</code> <code>. ~/.config/guix/current/etc/profile</code></li>
<li><code>sudo -E guix system reconfigure /etc/guix-os.scm</code></li>
</ul></li>
<li>run guix vm
<ul class="org-ul">
<li><code>qemu-system-x86_64 -nic user,model=virtio-net-pci,hostfwd=tcp::10022-:22 -enable-kvm -m 1024 -device virtio-blk,drive=myhd -drive if=none,file=$MY_IMAGE,id=myhd -spice port=5930,disable-ticketing</code></li>
</ul></li>
<li>grow vm disk
<ul class="org-ul">
<li><code>qemu-image resize IMAGE.qcow2 +10G</code></li>
<li><code>growpart /dev/vda 2</code></li>
<li><code>resize2fs /dev/vda2</code></li>
</ul></li>
</ul></li>
<li><code>guix hash -xr .</code> for the checksum of a repo</li>
<li><code>guix publish</code> substitutes after exporting/importing key with <code>guix archive</code> or use nars with <code>guix archive --export -r</code></li>
</ul></li>
<li>packages are standard SRFI-9 guile records (set-fields, etc&#x2026;)</li>
<li>nonguix substitutes at <code>substitutes.nonguix.org</code> key is <code>/signing-key.pub</code>.</li>
<li><code>guix time-machine --commit=a4eae0c3adce8e4c4ac153a4959d18b9897a67e1 -- package -i old</code></li>
<li>manual setup</li>
</ul>
<div class="org-src-container">
<pre class="src src-shell" id="orgdd3efa1">#https://git.savannah.gnu.org/cgit/guix.git/plain/etc/guix-install.sh
# get tarball for system=x86_64-linux,aarch64,armhf,i686
wget https://ftp.gnu.org/gnu/guix/guix-binary-1.0.1.x86_64-linux.tar.xz
# check sig
wget https://sv.gnu.org/people/viewgpg.php?user_id=15145 -qO - | gpg --import
wget https://ftp.gnu.org/gnu/guix/guix-binary-1.0.1.x86_64-linux.tar.xz.sig
gpg --verify guix-binary-1.0.1.x86_64-linux.tar.xz.sig
# with root
sudo -i
# untar into dirs
tar --warning=no-timestamp -xf /path/to/guix-binary-1.0.1.x86_64-linux.tar.xz
mv var/guix /var/ &amp;&amp; mv gnu /
# add guix profile
mkdir -p ~root/.config/guix
ln -sf /var/guix/profiles/per-user/root/current-guix ~root/.config/guix/current
# setup build daemon for multiple users
cp ~root/.config/guix/current/lib/systemd/system/guix-daemon.service /etc/systemd/system/
# add build users
groupadd --system guixbuild
for i in `seq -w 1 10`;
do
    useradd -g guixbuild -G guixbuild           \
            -d /var/empty -s `which nologin`    \
            -c "Guix build user $i" --system    \
            guixbuilder$i;
done
# link guix and info for all users
mkdir -p /usr/local/bin
cd /usr/local/bin
ln -s /var/guix/profiles/per-user/root/current-guix/bin/guix
mkdir -p /usr/local/share/info
cd /usr/local/share/info
for i in /var/guix/profiles/per-user/root/current-guix/share/info/* ;
do ln -s $i ; done
# source guix profile and add sub servers
source ~/root/.config/guix/current/etc/profile
guix archive --authorize &lt; ~root/.config/guix/current/share/guix/ci.guix.gnu.org.pub
guix archive --authorize &lt; ~root/.config/guix/current/share/guix/bordeaux.guix.gnu.org.pub
# install locale
guix package -i glibc-utf8-locales
</pre>
</div>
<ul class="org-ul">
<li>manual install
<ul class="org-ul">
<li>create wifi.conf with</li>
</ul></li>
</ul>
<div class="org-src-container">
<pre class="src src-conf" id="org9141850">network={
  ssid="ssid-name"
  key_mgmt=WPA-PSK
  psk="unencrypted passphrase"
}
</pre>
</div>
<ul class="org-ul">
<li><code>rfkill unblock all &amp;&amp; ifconfig -a &amp;&amp; wpa_supplicant -c wifi.conf -i INTERFACE -B &amp;&amp; dhclient -v INTERFACE</code></li>
<li>partition with <code>lsblk &amp;&amp; cfdisk</code></li>
<li>format with mkfs</li>
<li>mount root as mnt and <code>/boot/efi</code> under <code>/mnt/boot/efi</code></li>
<li>swapon the device</li>
<li><code>herd start cow-store /mnt</code></li>
<li>clone config, symlink channels, pull then <code>guix system -L CONFIG_DIR init config.scm /mnt</code></li>
</ul>
<div class="org-src-container">
<pre class="src src-sh" id="org2631d8f">guix shell --container --network --emulate-fhs \
    --development ungoogled-chromium gcc:lib \
    --preserve='^DISPLAY$' \
    --preserve='^XAUTHORITY$' --expose=$XAUTHORITY \
    --preserve='^DBUS_' --expose=/var/run/dbus \
    --expose=/sys/dev --expose=/sys/devices --expose=/dev/dri \
    -- ./VSCodium-1.74.0.22342.glibc2.17-x86_64.AppImage --appimage-extract-and-run # Run VSCodium Appimage

guix shell --network --container --emulate-fhs \
    bash coreutils curl grep nss-certs gcc:lib gcc-toolchain \
    pkg-config glib cairo atk pango@1.48.10 gdk-pixbuf gtk+ git \
    --share=$HOME/temphome=$HOME --no-cwd

curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh # install rustup in guix

guix shell --container --network --emulate-fhs \
    --preserve='^DISPLAY$' \
    --preserve='^XAUTHORITY$' --expose=$XAUTHORITY \
    alsa-lib bash coreutils dbus-glib file gcc:lib \
    grep gtk+ libcxx pciutils sed \
    -- ./start-tor-browser.desktop -v ; # Start tor-browser
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh" id="orgf3fecd7">GUIX_DAEMON_SOCKET=$XDG_DATA_HOME/guix/var/guix/daemon-socket/socket
GUIX_DATABASE_DIRECTORY=$XDG_DATA_HOME/guix/var/guix/db
GUIX_LOG_DIRECTORY=$XDG_DATA_HOME/guix/var/log/guix
GUIX_STATE_DIRECTORY=$XDG_DATA_HOME/guix/var/guix
GUIX_CONFIGURATION_DIRECTORY=$XDG_CONFIG_HOME/guix/etc
GUIX_LOCPATH=$XDG_DATA_HOME/guix/var/guix/profiles/per-user/root/guix-profile/lib/locale
NIX_STORE=$XDG_DATA_HOME/guix/gnu/store
</pre>
</div>
</div>
</div>

<div id="outline-container-orge4d6122" class="outline-3">
<h3 id="orge4d6122">guix issues</h3>
<div class="outline-text-3" id="text-orge4d6122">
</div>
<div id="outline-container-orgcf16313" class="outline-4">
<h4 id="orgcf16313"><span class="todo TODO">TODO</span> [PATCH v1] initrd: Allow extra search paths with ‚Äòinitrd-extra-module-paths‚Äô&#xa0;&#xa0;&#xa0;<span class="tag"><span class="patch">patch</span></span></h4>
<div class="outline-text-4" id="text-orgcf16313">
<p>
<span class="timestamp-wrapper"><span class="timestamp">[2022-05-02 Mon] </span></span> Submitted
</p>
<p>
:DEBBUGS<sub>ID</sub>: 55231
:CREATOR: Brian Cully &lt;bjc@spork.org&gt;
</p>
<p>
<a href="(progn (debbugs-org-mode 1) (debbugs-gnu-select-report))">Messages</a>
<span class="timestamp-wrapper"><span class="timestamp">[2022-06-21 Tue] </span></span> Last modified
</p>
</div>
</div>

<div id="outline-container-orgfab93e1" class="outline-4">
<h4 id="orgfab93e1"><span class="todo TODO">TODO</span> Add support for file capabilities(7)&#xa0;&#xa0;&#xa0;<span class="tag"><span class="patch">patch</span></span></h4>
<div class="outline-text-4" id="text-orgfab93e1">
<p>
<span class="timestamp-wrapper"><span class="timestamp">[2023-02-12 Sun] </span></span> Submitted
</p>
<p>
:DEBBUGS<sub>ID</sub>: 61462
:CREATOR: Tobias Geerinckx-Rice &lt;me@tobias.gr&gt;
</p>
<p>
<a href="(debbugs-gnu-select-report)">Messages</a>
<span class="timestamp-wrapper"><span class="timestamp">[2023-12-23 Sat] </span></span> Last modified
</p>

<div class="org-src-container">
<pre class="src src-scheme" id="orgea7be22">; WIP This does not work as it can't find patches? (ghostscript)
(define-module (etc httm-manifest)
 #:use-module (guix scripts pack)
 #:use-module (guix gexp)
 #:use-module (guix monads)
 #:use-module (guix profiles)
 #:use-module (guix store)
 #:use-module (guix derivations)
 #:use-module (guix modules)
 #:use-module (gnu packages)
 #:use-module (gnu packages gnupg)
 #:use-module (gnu packages guile)
 #:use-module (gnu packages ghostscript)

 )

;(display (source-module-closure '((guix scripts pack)
;                                  (guix monads)
;                                  (guix profiles)
;                                  (guix store)
;                                  (guix derivations))))

  (manifest
   (list
    (manifest-entry
     (name "httm-binary-tarball")
     (version "0.30.0")
     (item (computed-file "httm-directory"
                          (with-extensions (list guile-gcrypt guile-zlib guile-git guile-bytestructures guile-json-4)
                                           (with-imported-modules (source-module-closure
                                                                   '(;(guix packages)
                                                                     ;(guix utils)
                                                                     ;(gnu compression)
                                                                     ;(gnu packages ghostscript)
                                                                     ;(gnu packages)
                                                                     (guix scripts pack)
                                                                     (guix monads)
                                                                     (guix profiles)
                                                                     (guix store)
                                                                     (guix derivations))
                                                                   ;(append %load-path (%patch-path)); load-path
                                                                   )
                          #~(let ((bin (string-append #$output "/bin")))
                              (mkdir #$output) (mkdir bin)
                              (use-modules ;(guix packages)
                                           ;(guix gexp)
                                           ;(guix utils)
                                           ;(gnu compression)
                                           ;(gnu packages ghostscript)
                                           ;(gnu packages)
                                           (guix scripts pack)
                                           (guix monads)
                                           (guix profiles)
                                           (guix store)
                                           (guix derivations))
                              (define (build-tarballs)
                                (run-with-store (open-connection)
                                                (mbegin %store-monad
                                                        ;(set-guile-for-build (default-guile))
                                                        (&gt;&gt;= (profile-derivation (packages-&gt;manifest (list "rust-httm-0.30")))
                                                             (lambda (profile)
                                                               (self-contained-tarball "httm-binary" profile
                                                                                       #:profile-name "rust-httm"
                                                                                      ;#:localstatedir? #t
                                                                                      ;#:compressor (lookup-compressor "xz")
                                                                                       ))))
                                                #:system "x86_64-linux"))
                              (symlink (derivation-&gt;output-path (build-tarballs)) (string-append bin "rust-httm.tar.xz"))))))))))

</pre>
</div>
</div>
</div>
</div>
</div>
</div>
</body>
</html>
